<!DOCTYPE html>
<html>
<head>
    <title>üîç AN√ÅLISE COMPLETA - Filtro de Dura√ß√£o</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; color: #cc0000; }
        .success { background: #e6ffe6; color: #006600; }
        .info { background: #e6f3ff; color: #0066cc; }
        .warning { background: #fff3cd; color: #856404; }
        button { margin: 5px; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç AN√ÅLISE COMPLETA - Problema do Filtro de Dura√ß√£o</h1>
    
    <div>
        <button onclick="runCompleteAnalysis()">üöÄ EXECUTAR AN√ÅLISE COMPLETA</button>
        <button onclick="clearResults()">üóëÔ∏è Limpar</button>
    </div>
    
    <div id="results">Clique em "EXECUTAR AN√ÅLISE COMPLETA" para come√ßar...</div>

    <script type="module">
        const supabaseUrl = 'https://lqpgfygqidzqxjxmhjkm.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxxcGdmeWdxaWR6cXhqeG1oamttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjU5OTc5NzYsImV4cCI6MjA0MTU3Mzk3Nn0.Gg_29rvEyJlGJfqWvUkRmUgwDCjqCiGXHe2RqfQWFU8';
        
        const resultsDiv = document.getElementById('results');
        let supabase;

        // Inicializar Supabase
        const { createClient } = await import('https://cdn.skypack.dev/@supabase/supabase-js@2');
        supabase = createClient(supabaseUrl, supabaseKey);

        window.clearResults = function() {
            resultsDiv.innerHTML = 'Resultados limpos. Clique em "EXECUTAR AN√ÅLISE COMPLETA" para come√ßar...';
        };

        window.runCompleteAnalysis = async function() {
            let html = '<div class="info"><h2>üîç INICIANDO AN√ÅLISE COMPLETA...</h2></div>';
            resultsDiv.innerHTML = html;

            try {
                // ETAPA 1: Verificar se a tabela calls existe e sua estrutura
                html += '<div class="info"><h3>üìä ETAPA 1: Verificar Estrutura da Tabela</h3></div>';
                
                try {
                    const { data: tableInfo, error: tableError } = await supabase
                        .from('calls')
                        .select('*')
                        .limit(1);

                    if (tableError) {
                        html += `<div class="error">‚ùå ERRO ao acessar tabela calls: ${tableError.message}</div>`;
                        resultsDiv.innerHTML = html;
                        return;
                    }

                    if (tableInfo && tableInfo.length > 0) {
                        const columns = Object.keys(tableInfo[0]);
                        html += '<div class="success">‚úÖ Tabela calls acess√≠vel</div>';
                        html += `<div class="debug"><strong>Colunas encontradas:</strong> ${columns.join(', ')}</div>`;
                        
                        if (columns.includes('duration')) {
                            html += '<div class="success">‚úÖ Campo "duration" existe</div>';
                        } else {
                            html += '<div class="error">‚ùå Campo "duration" N√ÉO EXISTE!</div>';
                            resultsDiv.innerHTML = html;
                            return;
                        }
                    }
                } catch (e) {
                    html += `<div class="error">‚ùå ERRO na verifica√ß√£o da tabela: ${e.message}</div>`;
                    resultsDiv.innerHTML = html;
                    return;
                }

                // ETAPA 2: Verificar dados de dura√ß√£o no banco
                html += '<div class="info"><h3>üìä ETAPA 2: Analisar Dados de Dura√ß√£o</h3></div>';
                
                const { data: allDurations, error: durError } = await supabase
                    .from('calls')
                    .select('id, duration, created_at')
                    .not('duration', 'is', null)
                    .order('duration', { ascending: false })
                    .limit(50);

                if (durError) {
                    html += `<div class="error">‚ùå ERRO ao buscar dura√ß√µes: ${durError.message}</div>`;
                } else if (!allDurations || allDurations.length === 0) {
                    html += '<div class="error">‚ùå NENHUMA chamada com dura√ß√£o encontrada no banco!</div>';
                } else {
                    const durations = allDurations.map(c => c.duration);
                    const maxDur = Math.max(...durations);
                    const minDur = Math.min(...durations);
                    const avgDur = durations.reduce((a, b) => a + b, 0) / durations.length;
                    
                    html += `<div class="success">‚úÖ ${allDurations.length} chamadas com dura√ß√£o encontradas</div>`;
                    html += `<div class="debug">
                        <strong>Estat√≠sticas:</strong><br>
                        ‚Ä¢ Menor dura√ß√£o: ${minDur}s<br>
                        ‚Ä¢ Maior dura√ß√£o: ${maxDur}s<br>
                        ‚Ä¢ Dura√ß√£o m√©dia: ${Math.round(avgDur)}s<br>
                        ‚Ä¢ Chamadas ‚â• 60s: ${durations.filter(d => d >= 60).length}<br>
                        ‚Ä¢ Chamadas ‚â• 100s: ${durations.filter(d => d >= 100).length}<br>
                        ‚Ä¢ Chamadas ‚â• 200s: ${durations.filter(d => d >= 200).length}
                    </div>`;

                    // Mostrar top 10 dura√ß√µes
                    html += '<div class="debug"><strong>Top 10 dura√ß√µes:</strong><br>';
                    allDurations.slice(0, 10).forEach((call, i) => {
                        html += `${i+1}. ${call.duration}s (ID: ${call.id})<br>`;
                    });
                    html += '</div>';
                }

                // ETAPA 3: Testar query exata com filtro ‚â• 100s
                html += '<div class="info"><h3>üéØ ETAPA 3: Testar Query com Filtro ‚â• 100s</h3></div>';
                
                const { data: filtered100, error: filter100Error } = await supabase
                    .from('calls')
                    .select('*')
                    .gte('duration', 100);

                if (filter100Error) {
                    html += `<div class="error">‚ùå ERRO na query gte(duration, 100): ${filter100Error.message}</div>`;
                } else {
                    html += `<div class="success">‚úÖ Query gte(duration, 100) executada: ${filtered100?.length || 0} resultados</div>`;
                    
                    if (filtered100 && filtered100.length > 0) {
                        html += '<div class="debug"><strong>Primeiras 5 chamadas ‚â• 100s:</strong><br>';
                        filtered100.slice(0, 5).forEach(call => {
                            html += `‚Ä¢ ID: ${call.id}, Dura√ß√£o: ${call.duration}s, Tipo: ${typeof call.duration}<br>`;
                        });
                        html += '</div>';
                    }
                }

                // ETAPA 4: Testar query com pagina√ß√£o (simular frontend)
                html += '<div class="info"><h3>üìã ETAPA 4: Simular Query do Frontend (com pagina√ß√£o)</h3></div>';
                
                const { data: paginatedData, error: pagError } = await supabase
                    .from('calls')
                    .select('*')
                    .gte('duration', 100)
                    .range(0, 49)
                    .order('duration', { ascending: false });

                if (pagError) {
                    html += `<div class="error">‚ùå ERRO na query paginada: ${pagError.message}</div>`;
                } else {
                    html += `<div class="success">‚úÖ Query paginada executada: ${paginatedData?.length || 0} resultados</div>`;
                }

                // ETAPA 5: Verificar pol√≠ticas RLS
                html += '<div class="info"><h3>üîí ETAPA 5: Verificar Pol√≠ticas de Seguran√ßa (RLS)</h3></div>';
                
                try {
                    // Tentar query sem filtros para ver se RLS est√° bloqueando
                    const { data: noFilterData, error: noFilterError } = await supabase
                        .from('calls')
                        .select('id, duration')
                        .limit(5);

                    if (noFilterError) {
                        html += `<div class="warning">‚ö†Ô∏è Poss√≠vel problema de RLS: ${noFilterError.message}</div>`;
                    } else {
                        html += `<div class="success">‚úÖ RLS OK - ${noFilterData?.length || 0} registros acess√≠veis sem filtros</div>`;
                    }
                } catch (e) {
                    html += `<div class="warning">‚ö†Ô∏è Erro ao testar RLS: ${e.message}</div>`;
                }

                // ETAPA 6: Testar diferentes tipos de filtro
                html += '<div class="info"><h3>üî¢ ETAPA 6: Testar Diferentes Tipos de Filtro</h3></div>';
                
                const testValues = [
                    { value: 100, type: 'number' },
                    { value: '100', type: 'string' },
                    { value: parseInt('100'), type: 'parseInt' }
                ];

                for (const test of testValues) {
                    try {
                        const { data: testData, error: testError } = await supabase
                            .from('calls')
                            .select('id, duration')
                            .gte('duration', test.value)
                            .limit(3);

                        if (testError) {
                            html += `<div class="error">‚ùå Filtro ${test.type} (${test.value}): ${testError.message}</div>`;
                        } else {
                            html += `<div class="debug">‚Ä¢ Filtro ${test.type} (${test.value}): ${testData?.length || 0} resultados</div>`;
                        }
                    } catch (e) {
                        html += `<div class="error">‚ùå Erro no teste ${test.type}: ${e.message}</div>`;
                    }
                }

                // ETAPA 7: Verificar se h√° problema com ordena√ß√£o
                html += '<div class="info"><h3>üìä ETAPA 7: Testar Diferentes Ordena√ß√µes</h3></div>';
                
                const orderTests = [
                    { field: 'duration', ascending: false, name: 'duration DESC' },
                    { field: 'created_at', ascending: false, name: 'created_at DESC' },
                    { field: 'id', ascending: true, name: 'id ASC' }
                ];

                for (const orderTest of orderTests) {
                    try {
                        const { data: orderData, error: orderError } = await supabase
                            .from('calls')
                            .select('id, duration, created_at')
                            .gte('duration', 100)
                            .order(orderTest.field, { ascending: orderTest.ascending })
                            .limit(3);

                        if (orderError) {
                            html += `<div class="error">‚ùå Ordena√ß√£o ${orderTest.name}: ${orderError.message}</div>`;
                        } else {
                            html += `<div class="debug">‚Ä¢ Ordena√ß√£o ${orderTest.name}: ${orderData?.length || 0} resultados</div>`;
                        }
                    } catch (e) {
                        html += `<div class="error">‚ùå Erro na ordena√ß√£o ${orderTest.name}: ${e.message}</div>`;
                    }
                }

                // ETAPA 8: Conclus√£o e diagn√≥stico
                html += '<div class="info"><h3>üéØ ETAPA 8: DIAGN√ìSTICO FINAL</h3></div>';
                
                if (filtered100 && filtered100.length > 0) {
                    html += '<div class="success">‚úÖ FILTRO EST√Å FUNCIONANDO - Problema pode estar no frontend ou na passagem de par√¢metros</div>';
                    html += '<div class="warning">‚ö†Ô∏è Verifique os logs do console na aplica√ß√£o para ver se os par√¢metros est√£o chegando corretamente no backend</div>';
                } else {
                    html += '<div class="error">‚ùå FILTRO N√ÉO EST√Å FUNCIONANDO - Problema no banco de dados ou configura√ß√£o do Supabase</div>';
                }

                html += '<div class="info"><h4>üîç Pr√≥ximos Passos Recomendados:</h4>';
                html += '<ol>';
                html += '<li>Verificar logs do console na aplica√ß√£o</li>';
                html += '<li>Verificar se os par√¢metros est√£o sendo enviados corretamente do frontend</li>';
                html += '<li>Verificar se h√° conflitos com outros filtros</li>';
                html += '<li>Testar query diretamente no SQL Editor do Supabase</li>';
                html += '</ol></div>';

                resultsDiv.innerHTML = html;

            } catch (error) {
                console.error('‚ùå Erro na an√°lise:', error);
                resultsDiv.innerHTML = html + `<div class="error">‚ùå ERRO GERAL: ${error.message}</div>`;
            }
        };
    </script>
</body>
</html>
