<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste Google Chat Webhook</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .success { border-color: #4caf50; background: #f1f8e9; }
        .error { border-color: #f44336; background: #ffebee; }
        .warning { border-color: #ff9800; background: #fff3e0; }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #4caf50; color: white; }
        .status.error { background: #f44336; color: white; }
        .status.warning { background: #ff9800; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Google Chat Webhook</h1>
        <p>Este teste verifica se o sistema de notifica√ß√µes do Google Chat est√° funcionando corretamente.</p>

        <div class="test-section">
            <h3>üìã Teste 1: Feedback Simples</h3>
            <p>Envia um feedback b√°sico para testar o webhook do Google Chat.</p>
            <button onclick="testFeedback()" id="btn-feedback">üöÄ Testar Feedback</button>
            <div id="result-feedback" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üñºÔ∏è Teste 2: Feedback com Imagem</h3>
            <p>Envia um feedback com imagem anexada para testar upload e notifica√ß√£o.</p>
            <input type="file" id="image-input" accept="image/*" style="margin: 10px 0;">
            <button onclick="testFeedbackWithImage()" id="btn-image">üñºÔ∏è Testar com Imagem</button>
            <div id="result-image" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîß Teste 3: Verificar Configura√ß√£o</h3>
            <p>Verifica se as vari√°veis de ambiente est√£o configuradas.</p>
            <button onclick="checkConfiguration()" id="btn-config">‚öôÔ∏è Verificar Config</button>
            <div id="result-config" class="log" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä Status do Sistema</h3>
            <div id="system-status">
                <div class="status warning">‚è≥ Aguardando teste...</div>
            </div>
        </div>
    </div>

    <script>
        let testResults = {
            feedback: null,
            image: null,
            config: null
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            element.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            element.scrollTop = element.scrollHeight;
        }

        function updateSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            const results = Object.values(testResults);
            const successCount = results.filter(r => r === 'success').length;
            const errorCount = results.filter(r => r === 'error').length;
            const totalTests = results.filter(r => r !== null).length;

            if (totalTests === 0) {
                statusDiv.innerHTML = '<div class="status warning">‚è≥ Aguardando teste...</div>';
            } else if (errorCount === 0) {
                statusDiv.innerHTML = `<div class="status success">‚úÖ Todos os testes passaram! (${successCount}/${totalTests})</div>`;
            } else if (successCount === 0) {
                statusDiv.innerHTML = `<div class="status error">‚ùå Todos os testes falharam! (${errorCount}/${totalTests})</div>`;
            } else {
                statusDiv.innerHTML = `<div class="status warning">‚ö†Ô∏è Testes mistos: ${successCount} sucesso, ${errorCount} erro (${totalTests} total)</div>`;
            }
        }

        async function testFeedback() {
            const button = document.getElementById('btn-feedback');
            const resultDiv = document.getElementById('result-feedback');
            
            button.disabled = true;
            button.textContent = '‚è≥ Enviando...';
            resultDiv.style.display = 'block';
            resultDiv.textContent = '';

            log('result-feedback', 'Iniciando teste de feedback...');

            try {
                const payload = {
                    type: 'Melhoria',
                    title: 'Teste de Webhook Google Chat',
                    description: 'Este √© um teste automatizado para verificar se o webhook do Google Chat est√° funcionando corretamente.',
                    includeMeta: true,
                    context: {
                        user: { name: 'Teste Automatizado', email: 'teste@ggv.com', role: 'Admin' },
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        appVersion: '1.0.0'
                    },
                    images: [],
                    imagesBase64: []
                };

                log('result-feedback', 'Enviando payload para o webhook...');
                console.log('üß™ TESTE - Payload:', payload);

                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const endpoint = isLocalhost ? '/.netlify/functions/feedback' : '/api/feedback';
                
                log('result-feedback', `Endpoint: ${endpoint}`);
                log('result-feedback', `Ambiente: ${isLocalhost ? 'Local' : 'Produ√ß√£o'}`);

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                log('result-feedback', `Status da resposta: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    log('result-feedback', '‚úÖ Feedback enviado com sucesso!');
                    log('result-feedback', `Resposta: ${JSON.stringify(result)}`);
                    testResults.feedback = 'success';
                } else {
                    const errorText = await response.text();
                    log('result-feedback', `‚ùå Erro na resposta: ${response.status}`);
                    log('result-feedback', `Detalhes: ${errorText}`);
                    testResults.feedback = 'error';
                }
            } catch (error) {
                log('result-feedback', `‚ùå Erro na requisi√ß√£o: ${error.message}`);
                testResults.feedback = 'error';
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Testar Feedback';
                updateSystemStatus();
            }
        }

        async function testFeedbackWithImage() {
            const button = document.getElementById('btn-image');
            const resultDiv = document.getElementById('result-image');
            const imageInput = document.getElementById('image-input');
            
            if (!imageInput.files || imageInput.files.length === 0) {
                alert('Por favor, selecione uma imagem primeiro!');
                return;
            }

            button.disabled = true;
            button.textContent = '‚è≥ Enviando...';
            resultDiv.style.display = 'block';
            resultDiv.textContent = '';

            log('result-image', 'Iniciando teste de feedback com imagem...');

            try {
                const file = imageInput.files[0];
                log('result-image', `Arquivo selecionado: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`);

                // Simular compress√£o (em produ√ß√£o seria feita pelo componente)
                const reader = new FileReader();
                const base64 = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });

                const payload = {
                    type: 'Bug',
                    title: 'Teste com Imagem',
                    description: 'Este √© um teste com imagem anexada para verificar se o upload e notifica√ß√£o funcionam corretamente.',
                    includeMeta: true,
                    context: {
                        user: { name: 'Teste Automatizado', email: 'teste@ggv.com', role: 'Admin' },
                        url: window.location.href,
                        userAgent: navigator.userAgent,
                        appVersion: '1.0.0'
                    },
                    images: [],
                    imagesBase64: [base64]
                };

                log('result-image', 'Enviando payload com imagem...');
                console.log('üß™ TESTE IMAGEM - Payload:', payload);

                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const endpoint = isLocalhost ? '/.netlify/functions/feedback' : '/api/feedback';
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                log('result-image', `Status da resposta: ${response.status}`);

                if (response.ok) {
                    const result = await response.json();
                    log('result-image', '‚úÖ Feedback com imagem enviado com sucesso!');
                    log('result-image', `Resposta: ${JSON.stringify(result)}`);
                    testResults.image = 'success';
                } else {
                    const errorText = await response.text();
                    log('result-image', `‚ùå Erro na resposta: ${response.status}`);
                    log('result-image', `Detalhes: ${errorText}`);
                    testResults.image = 'error';
                }
            } catch (error) {
                log('result-image', `‚ùå Erro na requisi√ß√£o: ${error.message}`);
                testResults.image = 'error';
            } finally {
                button.disabled = false;
                button.textContent = 'üñºÔ∏è Testar com Imagem';
                updateSystemStatus();
            }
        }

        async function checkConfiguration() {
            const button = document.getElementById('btn-config');
            const resultDiv = document.getElementById('result-config');
            
            button.disabled = true;
            button.textContent = '‚è≥ Verificando...';
            resultDiv.style.display = 'block';
            resultDiv.textContent = '';

            log('result-config', 'Verificando configura√ß√£o do sistema...');

            try {
                // Testar se o endpoint est√° acess√≠vel
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const endpoint = isLocalhost ? '/.netlify/functions/feedback' : '/api/feedback';
                
                log('result-config', `Endpoint: ${endpoint}`);
                log('result-config', `Ambiente: ${isLocalhost ? 'Local' : 'Produ√ß√£o'}`);
                log('result-config', `Hostname: ${window.location.hostname}`);

                // Testar se o endpoint responde
                const response = await fetch(endpoint, {
                    method: 'OPTIONS',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    log('result-config', '‚úÖ Endpoint est√° acess√≠vel');
                    testResults.config = 'success';
                } else {
                    log('result-config', `‚ö†Ô∏è Endpoint retornou status: ${response.status}`);
                    testResults.config = 'warning';
                }

                // Verificar se estamos em ambiente de produ√ß√£o
                if (!isLocalhost) {
                    log('result-config', 'üåç Ambiente de produ√ß√£o detectado');
                    log('result-config', '‚ö†Ô∏è Verifique se GOOGLE_CHAT_WEBHOOK_URL est√° configurado no Netlify');
                } else {
                    log('result-config', 'üñ•Ô∏è Ambiente local detectado');
                    log('result-config', '‚ö†Ô∏è Em desenvolvimento, o webhook pode n√£o estar configurado');
                }

            } catch (error) {
                log('result-config', `‚ùå Erro ao verificar configura√ß√£o: ${error.message}`);
                testResults.config = 'error';
            } finally {
                button.disabled = false;
                button.textContent = '‚öôÔ∏è Verificar Config';
                updateSystemStatus();
            }
        }

        // Auto-verificar configura√ß√£o ao carregar
        window.addEventListener('load', () => {
            setTimeout(checkConfiguration, 1000);
        });
    </script>
</body>
</html>
