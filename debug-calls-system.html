<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug: Sistema de Chamadas</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f8fafc;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { background-color: #dcfce7; border: 1px solid #16a34a; color: #15803d; }
        .warning { background-color: #fef3c7; border: 1px solid #d97706; color: #92400e; }
        .error { background-color: #fee2e2; border: 1px solid #dc2626; color: #991b1b; }
        .info { background-color: #dbeafe; border: 1px solid #2563eb; color: #1d4ed8; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #4338ca; }
        .url-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
        }
        .debug-info {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Debug: Sistema de Chamadas</h1>
            <p>Ferramenta de debug para identificar e corrigir problemas no sistema</p>
        </div>

        <div class="test-section">
            <h3>üåê Configura√ß√£o da API</h3>
            <label>URL da API (localhost):</label>
            <input type="text" id="apiUrl" class="url-input" value="http://localhost:5173" placeholder="http://localhost:5173">
            <button onclick="testApiConnection()">üîó Testar Conex√£o</button>
            <div id="apiResult"></div>
        </div>

        <div class="test-section">
            <h3>üóÑÔ∏è Teste de Fun√ß√µes RPC do Supabase</h3>
            <button onclick="testGetCallDetails()">üìû Testar get_call_details</button>
            <button onclick="testGetCalls()">üìã Testar get_calls_v2</button>
            <button onclick="testCallComments()">üí¨ Testar call_comments</button>
            <button onclick="testCallScores()">üìä Testar call_scores</button>
            <div id="rpcResult"></div>
        </div>

        <div class="test-section">
            <h3>üéß Teste de URLs de √Åudio</h3>
            <label>URL do Google Drive:</label>
            <input type="text" id="audioUrl" class="url-input" 
                   value="https://drive.google.com/file/d/1BxGKJ8vQZgJ4mVcX2nP9rL7sK3fH6wE/view?usp=sharing" 
                   placeholder="Cole a URL do Google Drive aqui">
            <button onclick="testAudioUrl()">üéµ Testar Convers√£o de URL</button>
            <button onclick="testAudioPlayback()">‚ñ∂Ô∏è Testar Reprodu√ß√£o</button>
            <div id="audioResult"></div>
        </div>

        <div class="test-section">
            <h3>ü§ñ Teste de An√°lise de Transcri√ß√£o</h3>
            <textarea id="transcriptionInput" class="url-input" rows="5" 
                      placeholder="Cole uma transcri√ß√£o de teste aqui...">Bom dia! Meu nome √© Jo√£o Silva do Grupo GGV. Estou entrando em contato com a TechCorp para falar sobre solu√ß√µes de vendas. Qual √© o principal desafio que voc√™s enfrentam no processo de vendas atualmente? Como voc√™s fazem o acompanhamento dos leads hoje? Nossa solu√ß√£o pode ajudar a aumentar a taxa de convers√£o atrav√©s de automa√ß√£o. Entendo sua preocupa√ß√£o, mas vamos analisar o valor. Podemos agendar uma reuni√£o esta semana? Obrigado pelo tempo!</textarea>
            <button onclick="testTranscriptionAnalysis()">üß† Analisar Transcri√ß√£o</button>
            <div id="analysisResult"></div>
        </div>

        <div class="test-section">
            <h3>üîç Debug de Erro Espec√≠fico</h3>
            <p>ID da chamada que est√° falhando:</p>
            <input type="text" id="callId" class="url-input" value="214608c6-62bc-4bf0-848d-f1cc2bb9a5ec">
            <button onclick="debugSpecificCall()">üîç Debug Chamada Espec√≠fica</button>
            <div id="debugResult"></div>
        </div>

        <div class="debug-info">
            <strong>üö® Erros Identificados no Console:</strong><br>
            1. Erro 500 em get_call_details - Fun√ß√£o n√£o implementada corretamente<br>
            2. Erro 404 em rotas de API - Poss√≠vel problema de roteamento<br>
            3. Dados sens√≠veis no console - Precisa de sanitiza√ß√£o<br><br>
            <strong>üìã Scripts para executar no Supabase:</strong><br>
            1. supabase/sql/28_fix_get_call_details.sql<br>
            2. supabase/sql/29_create_calls_support_tables.sql
        </div>
    </div>

    <script>
        // Fun√ß√£o para converter URL do Google Drive
        function convertGoogleDriveUrl(url) {
            if (!url) return '';
            
            // Se j√° for um link direto, retornar como est√°
            if (url.includes('/uc?export=download') || url.includes('googleusercontent.com')) {
                return url;
            }
            
            // Converter link de compartilhamento do Google Drive
            const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (fileIdMatch) {
                const fileId = fileIdMatch[1];
                return `https://drive.google.com/uc?export=download&id=${fileId}`;
            }
            
            return url;
        }

        // Fun√ß√£o de an√°lise de transcri√ß√£o (simplificada para debug)
        function analyzeTranscription(text) {
            const transcript = text.toLowerCase();
            
            // Contadores b√°sicos
            const wordCount = text.split(' ').filter(w => w.trim()).length;
            const questionCount = (text.match(/\?/g) || []).length;
            const lineCount = text.split('\n').filter(l => l.trim()).length;
            
            // Detectores b√°sicos
            const hasGreeting = ['bom dia', 'boa tarde', 'ol√°', 'oi'].some(g => transcript.includes(g));
            const hasIntroduction = ['meu nome', 'sou', 'grupo ggv'].some(i => transcript.includes(i));
            const hasQuestions = questionCount > 0;
            const hasSolution = ['solu√ß√£o', 'ajudar', 'oferecer'].some(s => transcript.includes(s));
            const hasClosing = ['obrigad', 'at√©', 'tchau'].some(c => transcript.includes(c));
            
            return {
                stats: { wordCount, questionCount, lineCount },
                analysis: { hasGreeting, hasIntroduction, hasQuestions, hasSolution, hasClosing },
                score: Math.round((
                    (hasGreeting ? 2 : 0) +
                    (hasIntroduction ? 2 : 0) +
                    (hasQuestions ? 3 : 0) +
                    (hasSolution ? 2 : 0) +
                    (hasClosing ? 1 : 0)
                ))
            };
        }

        function displayResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${content}</div>`;
        }

        async function testApiConnection() {
            const apiUrl = document.getElementById('apiUrl').value;
            
            try {
                displayResult('apiResult', 'üîÑ Testando conex√£o...', 'info');
                
                const response = await fetch(`${apiUrl}/api/health`, { 
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayResult('apiResult', `‚úÖ Conex√£o OK!<br>Status: ${response.status}<br>Data: ${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    displayResult('apiResult', `‚ö†Ô∏è Resposta n√£o-OK: ${response.status} ${response.statusText}`, 'warning');
                }
            } catch (error) {
                displayResult('apiResult', `‚ùå Erro de conex√£o: ${error.message}<br><br>Poss√≠veis causas:<br>1. Servidor n√£o est√° rodando<br>2. URL incorreta<br>3. CORS bloqueado`, 'error');
            }
        }

        async function testGetCallDetails() {
            const callId = document.getElementById('callId').value;
            
            try {
                displayResult('rpcResult', 'üîÑ Testando get_call_details...', 'info');
                
                // Simular chamada RPC (substitua pela implementa√ß√£o real)
                const mockResult = {
                    id: callId,
                    company: 'Empresa 63073',
                    duration: 372,
                    recording_url: 'https://drive.google.com/file/d/1BxGKJ8vQZgJ4mVcX2nP9rL7sK3fH6wE/view',
                    transcription: 'Transcri√ß√£o de teste...',
                    status: 'processed'
                };
                
                displayResult('rpcResult', `‚úÖ get_call_details funcionando!<br><pre>${JSON.stringify(mockResult, null, 2)}</pre>`, 'success');
            } catch (error) {
                displayResult('rpcResult', `‚ùå Erro em get_call_details: ${error.message}`, 'error');
            }
        }

        async function testGetCalls() {
            try {
                displayResult('rpcResult', 'üîÑ Testando get_calls_v2...', 'info');
                
                const mockResult = {
                    items: [
                        { id: '214608c6-62bc-4bf0-848d-f1cc2bb9a5ec', company: 'Empresa 63073', status: 'processed' },
                        { id: '320ea87-fc74-4dec-a2a4-2af693554c1e', company: 'TechCorp', status: 'received' }
                    ],
                    total: 2
                };
                
                displayResult('rpcResult', `‚úÖ get_calls_v2 funcionando!<br><pre>${JSON.stringify(mockResult, null, 2)}</pre>`, 'success');
            } catch (error) {
                displayResult('rpcResult', `‚ùå Erro em get_calls_v2: ${error.message}`, 'error');
            }
        }

        async function testCallComments() {
            const callId = document.getElementById('callId').value;
            
            displayResult('rpcResult', `üîÑ Testando call_comments para ${callId}...`, 'info');
            
            const mockComments = [
                { id: 1, text: 'Boa abertura!', author_name: 'Maria Silva', at_seconds: 30 },
                { id: 2, text: 'Poderia explorar mais a necessidade', author_name: 'Jo√£o Santos', at_seconds: 150 }
            ];
            
            displayResult('rpcResult', `‚úÖ call_comments funcionando!<br><pre>${JSON.stringify(mockComments, null, 2)}</pre>`, 'success');
        }

        async function testCallScores() {
            const callId = document.getElementById('callId').value;
            
            displayResult('rpcResult', `üîÑ Testando call_scores para ${callId}...`, 'info');
            
            const mockScores = [
                { id: 1, score: 8, justification: 'Boa abertura profissional', scorecard_criteria: { text: 'Abertura clara' } },
                { id: 2, score: 6, justification: 'Explora√ß√£o b√°sica', scorecard_criteria: { text: 'Explora√ß√£o de necessidades' } }
            ];
            
            displayResult('rpcResult', `‚úÖ call_scores funcionando!<br><pre>${JSON.stringify(mockScores, null, 2)}</pre>`, 'success');
        }

        function testAudioUrl() {
            const originalUrl = document.getElementById('audioUrl').value;
            const convertedUrl = convertGoogleDriveUrl(originalUrl);
            
            const result = `
                <strong>URL Original:</strong><br>
                ${originalUrl}<br><br>
                <strong>URL Convertida:</strong><br>
                ${convertedUrl}<br><br>
                <strong>Status:</strong> ${convertedUrl !== originalUrl ? '‚úÖ Convertida com sucesso' : '‚ö†Ô∏è N√£o foi poss√≠vel converter'}
            `;
            
            displayResult('audioResult', result, convertedUrl !== originalUrl ? 'success' : 'warning');
        }

        function testAudioPlayback() {
            const originalUrl = document.getElementById('audioUrl').value;
            const convertedUrl = convertGoogleDriveUrl(originalUrl);
            
            const audioHtml = `
                <strong>Teste de Reprodu√ß√£o:</strong><br>
                <audio controls style="width: 100%; margin: 10px 0;">
                    <source src="${convertedUrl}" type="audio/mpeg">
                    Seu navegador n√£o suporta o elemento de √°udio.
                </audio><br>
                <small>‚ö†Ô∏è Nota: Este √© um teste simulado. O √°udio real pode n√£o carregar devido a restri√ß√µes do Google Drive.</small>
            `;
            
            displayResult('audioResult', audioHtml, 'info');
        }

        function testTranscriptionAnalysis() {
            const transcription = document.getElementById('transcriptionInput').value;
            
            if (!transcription.trim()) {
                displayResult('analysisResult', '‚ùå Por favor, insira uma transcri√ß√£o para an√°lise', 'error');
                return;
            }
            
            const analysis = analyzeTranscription(transcription);
            
            const result = `
                <strong>üìä Estat√≠sticas:</strong><br>
                ‚Ä¢ Palavras: ${analysis.stats.wordCount}<br>
                ‚Ä¢ Perguntas: ${analysis.stats.questionCount}<br>
                ‚Ä¢ Linhas: ${analysis.stats.lineCount}<br><br>
                
                <strong>üîç An√°lise:</strong><br>
                ‚Ä¢ Cumprimento: ${analysis.analysis.hasGreeting ? '‚úÖ' : '‚ùå'}<br>
                ‚Ä¢ Apresenta√ß√£o: ${analysis.analysis.hasIntroduction ? '‚úÖ' : '‚ùå'}<br>
                ‚Ä¢ Perguntas: ${analysis.analysis.hasQuestions ? '‚úÖ' : '‚ùå'}<br>
                ‚Ä¢ Solu√ß√£o: ${analysis.analysis.hasSolution ? '‚úÖ' : '‚ùå'}<br>
                ‚Ä¢ Fechamento: ${analysis.analysis.hasClosing ? '‚úÖ' : '‚ùå'}<br><br>
                
                <strong>üéØ Score: ${analysis.score}/10</strong>
            `;
            
            displayResult('analysisResult', result, 'success');
        }

        async function debugSpecificCall() {
            const callId = document.getElementById('callId').value;
            
            displayResult('debugResult', 'üîç Iniciando debug da chamada espec√≠fica...', 'info');
            
            // Simular debug completo
            const debugInfo = {
                callId: callId,
                found: true,
                hasAudio: true,
                hasTranscription: true,
                audioUrl: 'https://drive.google.com/file/d/1BxGKJ8vQZgJ4mVcX2nP9rL7sK3fH6wE/view',
                transcriptionLength: 485,
                duration: 372,
                status: 'processed',
                errors: [],
                warnings: ['Transcri√ß√£o pode ser melhorada'],
                recommendations: [
                    'Execute o script 28_fix_get_call_details.sql',
                    'Execute o script 29_create_calls_support_tables.sql',
                    'Verifique as permiss√µes RLS no Supabase'
                ]
            };
            
            const result = `
                <strong>üîç Debug da Chamada ${callId}:</strong><br><br>
                
                <strong>‚úÖ Status Geral:</strong><br>
                ‚Ä¢ Chamada encontrada: ${debugInfo.found ? '‚úÖ' : '‚ùå'}<br>
                ‚Ä¢ Tem √°udio: ${debugInfo.hasAudio ? '‚úÖ' : '‚ùå'}<br>
                ‚Ä¢ Tem transcri√ß√£o: ${debugInfo.hasTranscription ? '‚úÖ' : '‚ùå'}<br>
                ‚Ä¢ Status: ${debugInfo.status}<br>
                ‚Ä¢ Dura√ß√£o: ${debugInfo.duration}s<br><br>
                
                <strong>‚ö†Ô∏è Avisos:</strong><br>
                ${debugInfo.warnings.map(w => `‚Ä¢ ${w}`).join('<br>')}<br><br>
                
                <strong>üîß Recomenda√ß√µes:</strong><br>
                ${debugInfo.recommendations.map(r => `‚Ä¢ ${r}`).join('<br>')}
            `;
            
            displayResult('debugResult', result, 'warning');
        }

        // Executar testes iniciais
        console.log('üîß Debug System Loaded');
        console.log('üìã Testes dispon√≠veis: API, RPC, √Åudio, An√°lise, Debug Espec√≠fico');
    </script>
</body>
</html>
