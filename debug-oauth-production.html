<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug OAuth Produ√ß√£o - app.grupoggv.com</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .config-item { margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug OAuth Produ√ß√£o</h1>
        <p><strong>Dom√≠nio:</strong> <code id="current-domain">app.grupoggv.com</code></p>
        <p><strong>URL Atual:</strong> <code id="current-url"></code></p>
        
        <div class="config-item">
            <h3>üîß Configura√ß√µes do Supabase</h3>
            <p><strong>URL:</strong> <code id="supabase-url"></code></p>
            <p><strong>Anon Key:</strong> <code id="supabase-key"></code></p>
            <div id="supabase-status" class="status"></div>
        </div>

        <div class="config-item">
            <h3>üåê Configura√ß√µes de Redirect</h3>
            <p><strong>Origin:</strong> <code id="window-origin"></code></p>
            <p><strong>Hostname:</strong> <code id="window-hostname"></code></p>
            <p><strong>Protocol:</strong> <code id="window-protocol"></code></p>
            <p><strong>Redirect URL:</strong> <code id="redirect-url"></code></p>
        </div>

        <div class="config-item">
            <h3>üîê Teste de OAuth</h3>
            <button onclick="testOAuth()">üöÄ Testar Login Google</button>
            <button onclick="checkSession()">üîç Verificar Sess√£o</button>
            <button onclick="clearCache()">üßπ Limpar Cache</button>
        </div>

        <div class="config-item">
            <h3>üìã Logs</h3>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = "https://mwlekwyxbfbxfxskywgx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13bGVrd3l4YmZieGZ4c2t5d2d4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMTIzMjEsImV4cCI6MjA2NTY4ODMyMX0.rFX9H2pcGLNX7n3vKLYGi72JKwjUw6oG38IZGjO90HE";

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('logs');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function updateUI() {
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('supabase-url').textContent = SUPABASE_URL;
            document.getElementById('supabase-key').textContent = SUPABASE_ANON_KEY.substring(0, 20) + '...';
            document.getElementById('window-origin').textContent = window.location.origin;
            document.getElementById('window-hostname').textContent = window.location.hostname;
            document.getElementById('window-protocol').textContent = window.location.protocol;
            
            // Determinar URL de redirect
            const isProduction = window.location.hostname === 'app.grupoggv.com';
            const redirectUrl = isProduction ? 'https://app.grupoggv.com' : window.location.origin;
            document.getElementById('redirect-url').textContent = redirectUrl;
            
            // Status do Supabase
            const statusElement = document.getElementById('supabase-status');
            if (SUPABASE_URL && SUPABASE_ANON_KEY) {
                statusElement.className = 'status success';
                statusElement.textContent = '‚úÖ Configurado corretamente';
            } else {
                statusElement.className = 'status error';
                statusElement.textContent = '‚ùå Configura√ß√£o incompleta';
            }
            
            log(`üîç UI atualizada - Dom√≠nio: ${window.location.hostname}, Produ√ß√£o: ${isProduction}`);
        }

        async function testOAuth() {
            try {
                log('üöÄ Iniciando teste de OAuth...');
                
                // Determinar URL de redirect
                const isProduction = window.location.hostname === 'app.grupoggv.com';
                const redirectUrl = isProduction ? 'https://app.grupoggv.com' : window.location.origin;
                
                log(`üîê Configura√ß√µes OAuth:
- Hostname: ${window.location.hostname}
- Produ√ß√£o: ${isProduction}
- Redirect URL: ${redirectUrl}
- Provider: Google`);

                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: redirectUrl,
                        scopes: 'openid email profile https://www.googleapis.com/auth/gmail.send',
                        queryParams: {
                            include_granted_scopes: 'true',
                            prompt: 'select_account'
                        }
                    }
                });

                if (error) {
                    log(`‚ùå Erro no OAuth: ${error.message}`, 'error');
                    log(`üîç Detalhes do erro: ${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    log(`‚úÖ OAuth iniciado com sucesso!`, 'success');
                    log(`üìã Dados: ${JSON.stringify(data, null, 2)}`);
                }
            } catch (error) {
                log(`üö® Erro inesperado: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }

        async function checkSession() {
            try {
                log('üîç Verificando sess√£o atual...');
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    log(`‚ùå Erro ao verificar sess√£o: ${error.message}`, 'error');
                } else if (session) {
                    log(`‚úÖ Sess√£o ativa encontrada!`, 'success');
                    log(`üë§ Usu√°rio: ${session.user.email}`);
                    log(`‚è∞ Expira em: ${new Date(session.expires_at * 1000).toLocaleString()}`);
                } else {
                    log(`‚ö†Ô∏è Nenhuma sess√£o ativa`, 'warning');
                }
            } catch (error) {
                log(`üö® Erro inesperado: ${error.message}`, 'error');
            }
        }

        function clearCache() {
            try {
                log('üßπ Limpando cache...');
                localStorage.clear();
                sessionStorage.clear();
                log('‚úÖ Cache limpo com sucesso!', 'success');
                log('üîÑ Recarregue a p√°gina para aplicar as mudan√ßas');
            } catch (error) {
                log(`‚ùå Erro ao limpar cache: ${error.message}`, 'error');
            }
        }

        // Verificar par√¢metros OAuth na URL
        function checkOAuthParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const hashParams = new URLSearchParams(window.location.hash.replace('#', ''));
            
            const authParams = ['access_token', 'refresh_token', 'expires_in', 'token_type', 'type', 'code', 'error', 'error_description'];
            let foundParams = [];
            
            authParams.forEach(param => {
                if (urlParams.has(param)) foundParams.push(`URL: ${param}=${urlParams.get(param)}`);
                if (hashParams.has(param)) foundParams.push(`Hash: ${param}=${hashParams.get(param)}`);
            });
            
            if (foundParams.length > 0) {
                log('üîç Par√¢metros OAuth encontrados na URL:', 'warning');
                foundParams.forEach(param => log(`  ${param}`));
            } else {
                log('‚ÑπÔ∏è Nenhum par√¢metro OAuth encontrado na URL');
            }
        }

        // Inicializar
        window.addEventListener('load', () => {
            updateUI();
            checkOAuthParams();
            log('üéØ Debug OAuth carregado - Pronto para testes!', 'success');
        });
    </script>
</body>
</html>
