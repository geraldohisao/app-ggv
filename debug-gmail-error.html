<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Debug Gmail Error - app.grupoggv.com</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Gmail Error - app.grupoggv.com</h1>
        <p><strong>Objetivo:</strong> Diagnosticar e resolver o erro do Google Identity Services no envio de e-mail.</p>

        <div class="section">
            <h3>üåê Informa√ß√µes do Ambiente</h3>
            <div class="code" id="env-info">Carregando...</div>
        </div>

        <div class="section">
            <h3>üîß Verifica√ß√£o de Configura√ß√£o</h3>
            <div class="status info" id="config-status">Aguardando verifica√ß√£o...</div>
            <button onclick="checkConfiguration()">Verificar Configura√ß√£o</button>
            <button onclick="checkCSP()">Verificar CSP</button>
        </div>

        <div class="section">
            <h3>üì¶ Google Identity Services</h3>
            <div class="status info" id="gis-status">Aguardando verifica√ß√£o...</div>
            <button onclick="testGoogleIdentityServices()">Testar Google Identity Services</button>
            <button onclick="forceReloadGIS()">Recarregar GIS</button>
        </div>

        <div class="section">
            <h3>üîë Teste de Autentica√ß√£o</h3>
            <div class="status info" id="auth-status">Aguardando teste...</div>
            <button onclick="testAuthentication()">Testar Autentica√ß√£o</button>
            <button onclick="clearTokens()">Limpar Tokens</button>
        </div>

        <div class="section">
            <h3>üìß Teste de Envio</h3>
            <div>
                <label>E-mail de teste:</label>
                <input type="email" id="test-email" value="test@grupoggv.com" style="width: 300px; padding: 5px; margin: 5px;">
            </div>
            <div class="status info" id="send-status">Aguardando teste...</div>
            <button onclick="testEmailSend()">Testar Envio</button>
        </div>

        <div class="section">
            <h3>üìä Logs de Debug</h3>
            <button onclick="clearLog()">Limpar Log</button>
            <button onclick="exportLog()">Exportar Log</button>
            <div class="log" id="debug-log"></div>
        </div>
    </div>

    <script>
        let debugLog = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            debugLog.push({ timestamp, message, type });
            
            const logElement = document.getElementById('debug-log');
            logElement.innerHTML += logEntry + '\n';
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }

        function updateStatus(elementId, status, message) {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = message;
        }

        function clearLog() {
            debugLog = [];
            document.getElementById('debug-log').innerHTML = '';
        }

        function exportLog() {
            const logText = debugLog.map(entry => 
                `[${entry.timestamp}] ${entry.message}`
            ).join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gmail-debug-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Verificar informa√ß√µes do ambiente
        function loadEnvironmentInfo() {
            const info = {
                hostname: window.location.hostname,
                protocol: window.location.protocol,
                port: window.location.port,
                userAgent: navigator.userAgent.substring(0, 100) + '...',
                cookiesEnabled: navigator.cookieEnabled,
                localStorage: typeof(Storage) !== "undefined",
                isProduction: window.location.hostname === 'app.grupoggv.com',
                hasLocalConfig: !!window.APP_CONFIG_LOCAL,
                googleAvailable: !!(window.google && window.google.accounts),
                currentTime: new Date().toISOString()
            };

            document.getElementById('env-info').innerHTML = Object.entries(info)
                .map(([key, value]) => `${key}: ${value}`)
                .join('<br>');

            log('üåê Informa√ß√µes do ambiente carregadas');
        }

        async function checkConfiguration() {
            log('üîß Verificando configura√ß√£o...');
            updateStatus('config-status', 'info', 'Verificando...');

            try {
                // Verificar Client ID
                let clientId = null;
                
                // Tentar obter do localStorage/configura√ß√£o local
                if (window.APP_CONFIG_LOCAL && window.APP_CONFIG_LOCAL.GOOGLE_OAUTH_CLIENT_ID) {
                    clientId = window.APP_CONFIG_LOCAL.GOOGLE_OAUTH_CLIENT_ID;
                    log('‚úÖ Client ID encontrado na configura√ß√£o local');
                } else {
                    log('‚ùå Client ID n√£o encontrado na configura√ß√£o local');
                }

                if (clientId) {
                    log(`üîë Client ID: ${clientId.substring(0, 20)}...`);
                    updateStatus('config-status', 'success', '‚úÖ Configura√ß√£o OK');
                } else {
                    updateStatus('config-status', 'error', '‚ùå Client ID n√£o configurado');
                    log('‚ùå GOOGLE_OAUTH_CLIENT_ID n√£o configurado');
                }

            } catch (error) {
                log(`‚ùå Erro na verifica√ß√£o: ${error.message}`);
                updateStatus('config-status', 'error', '‚ùå Erro na verifica√ß√£o');
            }
        }

        async function testGoogleIdentityServices() {
            log('üì¶ Testando Google Identity Services...');
            updateStatus('gis-status', 'info', 'Carregando...');

            try {
                // Verificar se j√° est√° carregado
                if (window.google && window.google.accounts && window.google.accounts.oauth2) {
                    log('‚úÖ Google Identity Services j√° carregado');
                    updateStatus('gis-status', 'success', '‚úÖ GIS carregado');
                    return;
                }

                // Tentar carregar
                log('üîÑ Carregando Google Identity Services...');
                
                const script = document.createElement('script');
                script.src = 'https://accounts.google.com/gsi/client';
                script.async = true;
                script.defer = true;

                const loadPromise = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout ao carregar Google Identity Services'));
                    }, 15000);

                    script.onload = () => {
                        clearTimeout(timeout);
                        setTimeout(() => {
                            if (window.google && window.google.accounts && window.google.accounts.oauth2) {
                                resolve(true);
                            } else {
                                reject(new Error('Google Identity Services n√£o inicializou'));
                            }
                        }, 500);
                    };

                    script.onerror = () => {
                        clearTimeout(timeout);
                        reject(new Error('Falha ao carregar script'));
                    };
                });

                document.head.appendChild(script);
                await loadPromise;

                log('‚úÖ Google Identity Services carregado com sucesso');
                updateStatus('gis-status', 'success', '‚úÖ GIS carregado');

            } catch (error) {
                log(`‚ùå Erro no GIS: ${error.message}`);
                updateStatus('gis-status', 'error', `‚ùå ${error.message}`);
            }
        }

        async function forceReloadGIS() {
            log('üîÑ For√ßando recarga do Google Identity Services...');
            
            // Remover scripts existentes
            const existingScripts = document.querySelectorAll('script[src*="gsi/client"]');
            existingScripts.forEach(script => script.remove());
            
            // Limpar vari√°veis globais
            if (window.google) {
                delete window.google;
            }
            
            log('üßπ Scripts antigos removidos');
            
            // Recarregar
            await testGoogleIdentityServices();
        }

        async function testAuthentication() {
            log('üîë Testando autentica√ß√£o...');
            updateStatus('auth-status', 'info', 'Testando...');

            try {
                // Verificar se GIS est√° dispon√≠vel
                if (!window.google || !window.google.accounts || !window.google.accounts.oauth2) {
                    throw new Error('Google Identity Services n√£o dispon√≠vel');
                }

                // Obter Client ID
                let clientId = null;
                if (window.APP_CONFIG_LOCAL && window.APP_CONFIG_LOCAL.GOOGLE_OAUTH_CLIENT_ID) {
                    clientId = window.APP_CONFIG_LOCAL.GOOGLE_OAUTH_CLIENT_ID;
                } else {
                    throw new Error('Client ID n√£o configurado');
                }

                log(`üîë Usando Client ID: ${clientId.substring(0, 20)}...`);

                // Criar token client
                const tokenClient = window.google.accounts.oauth2.initTokenClient({
                    client_id: clientId,
                    scope: 'https://www.googleapis.com/auth/gmail.send https://www.googleapis.com/auth/gmail.compose',
                    prompt: 'consent',
                    callback: (response) => {
                        if (response.access_token) {
                            log('‚úÖ Token obtido com sucesso');
                            updateStatus('auth-status', 'success', '‚úÖ Autentica√ß√£o OK');
                        } else {
                            log(`‚ùå Erro na resposta: ${response.error || 'Desconhecido'}`);
                            updateStatus('auth-status', 'error', '‚ùå Erro na autentica√ß√£o');
                        }
                    }
                });

                log('üîÑ Solicitando token...');
                tokenClient.requestAccessToken();

            } catch (error) {
                log(`‚ùå Erro na autentica√ß√£o: ${error.message}`);
                updateStatus('auth-status', 'error', `‚ùå ${error.message}`);
            }
        }

        function clearTokens() {
            log('üßπ Limpando tokens...');
            
            // Limpar localStorage
            Object.keys(localStorage).forEach(key => {
                if (key.includes('gmail') || key.includes('google') || key.includes('token')) {
                    localStorage.removeItem(key);
                    log(`üóëÔ∏è Removido: ${key}`);
                }
            });

            // Limpar sessionStorage
            Object.keys(sessionStorage).forEach(key => {
                if (key.includes('gmail') || key.includes('google') || key.includes('token')) {
                    sessionStorage.removeItem(key);
                    log(`üóëÔ∏è Removido: ${key}`);
                }
            });

            log('‚úÖ Tokens limpos');
        }

        async function checkCSP() {
            log('üõ°Ô∏è Verificando Content Security Policy...');
            
            try {
                // Tentar carregar um script do Google para testar CSP
                const testScript = document.createElement('script');
                testScript.src = 'https://accounts.google.com/gsi/client';
                
                const cspTest = new Promise((resolve, reject) => {
                    const timeout = setTimeout(() => {
                        reject(new Error('Timeout - poss√≠vel bloqueio de CSP'));
                    }, 5000);
                    
                    testScript.onload = () => {
                        clearTimeout(timeout);
                        resolve('CSP permite carregamento de scripts do Google');
                    };
                    
                    testScript.onerror = (error) => {
                        clearTimeout(timeout);
                        reject(new Error('CSP bloqueou o carregamento do script'));
                    };
                });
                
                document.head.appendChild(testScript);
                const result = await cspTest;
                
                log(`‚úÖ CSP OK: ${result}`);
                updateStatus('config-status', 'success', '‚úÖ CSP permite Google Services');
                
            } catch (error) {
                log(`‚ùå Problema de CSP: ${error.message}`);
                updateStatus('config-status', 'error', `‚ùå CSP bloqueando: ${error.message}`);
            }
        }

        async function testEmailSend() {
            const email = document.getElementById('test-email').value;
            if (!email) {
                updateStatus('send-status', 'error', '‚ùå Digite um e-mail');
                return;
            }

            log(`üìß Testando envio para: ${email}`);
            updateStatus('send-status', 'info', 'Enviando...');

            try {
                // Este √© apenas um teste de simula√ß√£o
                // Na aplica√ß√£o real, seria chamado sendEmailViaGmail
                
                log('‚ö†Ô∏è Teste simulado - fun√ß√£o real n√£o dispon√≠vel neste contexto');
                updateStatus('send-status', 'warning', '‚ö†Ô∏è Teste simulado');
                
                setTimeout(() => {
                    log('‚úÖ Teste simulado conclu√≠do');
                    updateStatus('send-status', 'info', '‚úÖ Teste simulado OK');
                }, 2000);

            } catch (error) {
                log(`‚ùå Erro no envio: ${error.message}`);
                updateStatus('send-status', 'error', `‚ùå ${error.message}`);
            }
        }

        // Executar verifica√ß√µes iniciais
        window.addEventListener('load', () => {
            loadEnvironmentInfo();
            setTimeout(() => {
                checkConfiguration();
                testGoogleIdentityServices();
            }, 1000);
        });
    </script>
</body>
</html>
