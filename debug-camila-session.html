<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debug Sessão Camila</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🔧 Debug Sessão da Camila</h1>
    
    <div class="step warning">
        <h3>📋 Instruções para a Camila:</h3>
        <p>1. Abra esta página no mesmo navegador onde está tentando acessar o feedback</p>
        <p>2. Clique em "Verificar Sessão"</p>
        <p>3. Se necessário, clique em "Limpar Tudo e Relogar"</p>
        <p>4. Teste o link novamente: <strong>/feedback?deal_id=632951</strong></p>
    </div>

    <div class="step">
        <button onclick="checkSession()">🔍 Verificar Sessão</button>
        <button onclick="clearAndReload()">🧹 Limpar Tudo e Relogar</button>
        <button onclick="testDirectAccess()">🔗 Testar Acesso Direto</button>
    </div>

    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            results.appendChild(div);
            console.log(message);
        }

        function checkSession() {
            document.getElementById('results').innerHTML = '';
            log('🔍 VERIFICANDO SESSÃO DA CAMILA...', 'info');

            // 1. Verificar localStorage
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                log('❌ PROBLEMA: Nenhum usuário no localStorage!', 'error');
                log('SOLUÇÃO: Faça login novamente', 'warning');
                return;
            }

            try {
                const user = JSON.parse(userStr);
                log(`✅ USUÁRIO ENCONTRADO:
Nome: ${user.name || 'N/A'}
Email: ${user.email || 'N/A'}
Função: ${user.user_function || 'N/A'}
Role: ${user.role || 'N/A'}
Timestamp: ${user.timestamp || 'N/A'}`, 'success');

                // 2. Verificar se é a Camila
                const isCamila = (user.name && user.name.toLowerCase().includes('camila')) ||
                                (user.email && user.email.toLowerCase().includes('camila'));
                
                if (!isCamila) {
                    log('⚠️ ATENÇÃO: Este não parece ser o usuário da Camila!', 'warning');
                } else {
                    log('✅ Confirmado: Este é o usuário da Camila', 'success');
                }

                // 3. Testar lógica de acesso
                const hasAccess = user.role === 'SUPER_ADMIN' || 
                                 user.user_function === 'Closer' || 
                                 user.user_function === 'Gestor';

                log(`🔐 TESTE DE ACESSO:
Role é SUPER_ADMIN? ${user.role === 'SUPER_ADMIN' ? 'SIM ✅' : 'NÃO ❌'}
Função é Closer? ${user.user_function === 'Closer' ? 'SIM ✅' : 'NÃO ❌'}
Função é Gestor? ${user.user_function === 'Gestor' ? 'SIM ✅' : 'NÃO ❌'}

RESULTADO: ${hasAccess ? '✅ DEVE TER ACESSO' : '❌ SEM ACESSO'}`, hasAccess ? 'success' : 'error');

                if (!hasAccess) {
                    log('🔧 PROBLEMA IDENTIFICADO: user_function não é Closer ou Gestor!', 'error');
                    log('SOLUÇÃO: Clique em "Limpar Tudo e Relogar"', 'warning');
                }

                // 4. Verificar timestamp da sessão
                if (user.timestamp) {
                    const sessionTime = new Date(user.timestamp);
                    const now = new Date();
                    const hoursDiff = (now.getTime() - sessionTime.getTime()) / (1000 * 60 * 60);
                    
                    log(`⏰ IDADE DA SESSÃO: ${hoursDiff.toFixed(1)} horas`, hoursDiff > 24 ? 'warning' : 'info');
                    
                    if (hoursDiff > 24) {
                        log('⚠️ SESSÃO ANTIGA: Recomendo fazer novo login', 'warning');
                    }
                }

            } catch (error) {
                log(`❌ ERRO ao processar dados do localStorage: ${error.message}`, 'error');
            }

            // 5. Verificar URL atual
            log(`🌐 URL ATUAL: ${window.location.href}`, 'info');
            log(`📍 PATH: ${window.location.pathname}`, 'info');
            log(`🔗 QUERY: ${window.location.search}`, 'info');
        }

        function clearAndReload() {
            log('🧹 LIMPANDO TODOS OS DADOS...', 'warning');
            
            // Limpar tudo
            localStorage.clear();
            sessionStorage.clear();
            
            // Limpar cookies (se houver)
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            log('✅ Dados limpos! Redirecionando para fazer login...', 'success');
            
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }

        function testDirectAccess() {
            log('🔗 TESTANDO ACESSO DIRETO...', 'info');
            
            const testUrl = '/feedback?deal_id=632951';
            log(`Tentando acessar: ${testUrl}`, 'info');
            
            setTimeout(() => {
                window.location.href = testUrl;
            }, 1000);
        }

        // Auto-executar verificação ao carregar
        window.onload = function() {
            setTimeout(checkSession, 500);
        };
    </script>
</body>
</html>
