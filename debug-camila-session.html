<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debug SessÃ£o Camila</title>
    <style>
        body { font-family: Arial; padding: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Debug SessÃ£o da Camila</h1>
    
    <div class="step warning">
        <h3>ğŸ“‹ InstruÃ§Ãµes para a Camila:</h3>
        <p>1. Abra esta pÃ¡gina no mesmo navegador onde estÃ¡ tentando acessar o feedback</p>
        <p>2. Clique em "Verificar SessÃ£o"</p>
        <p>3. Se necessÃ¡rio, clique em "Limpar Tudo e Relogar"</p>
        <p>4. Teste o link novamente: <strong>/feedback?deal_id=632951</strong></p>
    </div>

    <div class="step">
        <button onclick="checkSession()">ğŸ” Verificar SessÃ£o</button>
        <button onclick="clearAndReload()">ğŸ§¹ Limpar Tudo e Relogar</button>
        <button onclick="testDirectAccess()">ğŸ”— Testar Acesso Direto</button>
    </div>

    <div id="results"></div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `step ${type}`;
            div.innerHTML = `<pre>${message}</pre>`;
            results.appendChild(div);
            console.log(message);
        }

        function checkSession() {
            document.getElementById('results').innerHTML = '';
            log('ğŸ” VERIFICANDO SESSÃƒO DA CAMILA...', 'info');

            // 1. Verificar localStorage
            const userStr = localStorage.getItem('user');
            if (!userStr) {
                log('âŒ PROBLEMA: Nenhum usuÃ¡rio no localStorage!', 'error');
                log('SOLUÃ‡ÃƒO: FaÃ§a login novamente', 'warning');
                return;
            }

            try {
                const user = JSON.parse(userStr);
                log(`âœ… USUÃRIO ENCONTRADO:
Nome: ${user.name || 'N/A'}
Email: ${user.email || 'N/A'}
FunÃ§Ã£o: ${user.user_function || 'N/A'}
Role: ${user.role || 'N/A'}
Timestamp: ${user.timestamp || 'N/A'}`, 'success');

                // 2. Verificar se Ã© a Camila
                const isCamila = (user.name && user.name.toLowerCase().includes('camila')) ||
                                (user.email && user.email.toLowerCase().includes('camila'));
                
                if (!isCamila) {
                    log('âš ï¸ ATENÃ‡ÃƒO: Este nÃ£o parece ser o usuÃ¡rio da Camila!', 'warning');
                } else {
                    log('âœ… Confirmado: Este Ã© o usuÃ¡rio da Camila', 'success');
                }

                // 3. Testar lÃ³gica de acesso
                const hasAccess = user.role === 'SUPER_ADMIN' || 
                                 user.user_function === 'Closer' || 
                                 user.user_function === 'Gestor';

                log(`ğŸ” TESTE DE ACESSO:
Role Ã© SUPER_ADMIN? ${user.role === 'SUPER_ADMIN' ? 'SIM âœ…' : 'NÃƒO âŒ'}
FunÃ§Ã£o Ã© Closer? ${user.user_function === 'Closer' ? 'SIM âœ…' : 'NÃƒO âŒ'}
FunÃ§Ã£o Ã© Gestor? ${user.user_function === 'Gestor' ? 'SIM âœ…' : 'NÃƒO âŒ'}

RESULTADO: ${hasAccess ? 'âœ… DEVE TER ACESSO' : 'âŒ SEM ACESSO'}`, hasAccess ? 'success' : 'error');

                if (!hasAccess) {
                    log('ğŸ”§ PROBLEMA IDENTIFICADO: user_function nÃ£o Ã© Closer ou Gestor!', 'error');
                    log('SOLUÃ‡ÃƒO: Clique em "Limpar Tudo e Relogar"', 'warning');
                }

                // 4. Verificar timestamp da sessÃ£o
                if (user.timestamp) {
                    const sessionTime = new Date(user.timestamp);
                    const now = new Date();
                    const hoursDiff = (now.getTime() - sessionTime.getTime()) / (1000 * 60 * 60);
                    
                    log(`â° IDADE DA SESSÃƒO: ${hoursDiff.toFixed(1)} horas`, hoursDiff > 24 ? 'warning' : 'info');
                    
                    if (hoursDiff > 24) {
                        log('âš ï¸ SESSÃƒO ANTIGA: Recomendo fazer novo login', 'warning');
                    }
                }

            } catch (error) {
                log(`âŒ ERRO ao processar dados do localStorage: ${error.message}`, 'error');
            }

            // 5. Verificar URL atual
            log(`ğŸŒ URL ATUAL: ${window.location.href}`, 'info');
            log(`ğŸ“ PATH: ${window.location.pathname}`, 'info');
            log(`ğŸ”— QUERY: ${window.location.search}`, 'info');
        }

        function clearAndReload() {
            log('ğŸ§¹ LIMPANDO TODOS OS DADOS...', 'warning');
            
            // Limpar tudo
            localStorage.clear();
            sessionStorage.clear();
            
            // Limpar cookies (se houver)
            document.cookie.split(";").forEach(function(c) { 
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
            });
            
            log('âœ… Dados limpos! Redirecionando para fazer login...', 'success');
            
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }

        function testDirectAccess() {
            log('ğŸ”— TESTANDO ACESSO DIRETO...', 'info');
            
            const testUrl = '/feedback?deal_id=632951';
            log(`Tentando acessar: ${testUrl}`, 'info');
            
            setTimeout(() => {
                window.location.href = testUrl;
            }, 1000);
        }

        // Auto-executar verificaÃ§Ã£o ao carregar
        window.onload = function() {
            setTimeout(checkSession, 500);
        };
    </script>
</body>
</html>
