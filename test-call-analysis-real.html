<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Teste: An√°lise de Chamadas com Dados Reais</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        .test-case {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f8fafc;
        }
        .result {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
        }
        .success { background-color: #dcfce7; border: 1px solid #16a34a; color: #15803d; }
        .warning { background-color: #fef3c7; border: 1px solid #d97706; color: #92400e; }
        .error { background-color: #fee2e2; border: 1px solid #dc2626; color: #991b1b; }
        .info { background-color: #dbeafe; border: 1px solid #2563eb; color: #1d4ed8; }
        button {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #4338ca; }
        .criteria-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .criterion {
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .score-high { background-color: #dcfce7; border-color: #16a34a; }
        .score-medium { background-color: #fef3c7; border-color: #d97706; }
        .score-low { background-color: #fee2e2; border-color: #dc2626; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Teste: Sistema de An√°lise de Chamadas</h1>
            <p>Testando a fun√ß√£o de an√°lise inteligente com dados reais do Supabase</p>
        </div>

        <div class="test-case">
            <h3>üìã Teste 1: Chamada Completa com Transcri√ß√£o</h3>
            <button onclick="testCompleteCall()">üöÄ Executar Teste</button>
            <div id="result1"></div>
        </div>

        <div class="test-case">
            <h3>üìã Teste 2: Chamada Sem Transcri√ß√£o (Apenas √Åudio)</h3>
            <button onclick="testCallWithoutTranscription()">üöÄ Executar Teste</button>
            <div id="result2"></div>
        </div>

        <div class="test-case">
            <h3>üìã Teste 3: Chamada Curta (< 1 minuto)</h3>
            <button onclick="testShortCall()">üöÄ Executar Teste</button>
            <div id="result3"></div>
        </div>

        <div class="test-case">
            <h3>üìã Teste 4: An√°lise de Scorecard Detalhado</h3>
            <button onclick="testDetailedScorecard()">üöÄ Executar Teste</button>
            <div id="result4"></div>
        </div>

        <div class="test-case">
            <h3>üéß Teste 5: Integra√ß√£o com √Åudio (Google Drive)</h3>
            <button onclick="testAudioIntegration()">üöÄ Executar Teste</button>
            <div id="result5"></div>
        </div>
    </div>

    <script>
        // ü§ñ FUN√á√ÉO DE AN√ÅLISE INTELIGENTE (Copiada do sistema real)
        function analyzeCallContent(transcription, duration, company, insights = {}) {
            const transcript = transcription.toLowerCase();
            const durationMinutes = Math.floor(duration / 60);
            
            console.log('üîç Iniciando an√°lise inteligente:', {
                transcriptionLength: transcription.length,
                durationMinutes,
                company,
                hasInsights: Object.keys(insights).length > 0
            });
            
            // CRIT√âRIO 1: ABERTURA CLARA E PROFISSIONAL
            const greetingWords = ['bom dia', 'boa tarde', 'boa noite', 'ol√°', 'oi', 'al√¥'];
            const introWords = ['meu nome', 'sou', 'me chamo', 'aqui √©', 'grupo ggv', 'ggv', 'empresa'];
            
            const hasGreeting = greetingWords.some(word => transcript.includes(word));
            const hasIntroduction = introWords.some(word => transcript.includes(word));
            const hasCompanyMention = transcript.includes(company.toLowerCase()) || transcript.includes('sua empresa');
            
            let openingScore = 0;
            if (hasGreeting) openingScore += 4;
            if (hasIntroduction) openingScore += 4;
            if (hasCompanyMention) openingScore += 2;
            openingScore = Math.min(10, openingScore + (durationMinutes > 1 ? 0 : -1));
            
            // CRIT√âRIO 2: EXPLORA√á√ÉO DE NECESSIDADES
            const questionMarks = (transcript.match(/\?/g) || []).length;
            const discoveryWords = ['necessidade', 'problema', 'desafio', 'objetivo', 'meta', 'dificuldade', 'situa√ß√£o', 'como', 'quando', 'onde', 'por que', 'qual'];
            const needsWords = discoveryWords.filter(word => transcript.includes(word)).length;
            
            let needsScore = 0;
            needsScore += Math.min(5, questionMarks * 0.8);
            needsScore += Math.min(3, needsWords * 0.5);
            needsScore += durationMinutes > 3 ? 2 : 0;
            needsScore = Math.min(10, needsScore);
            
            // CRIT√âRIO 3: APRESENTA√á√ÉO DA SOLU√á√ÉO
            const solutionWords = ['solu√ß√£o', 'ajudar', 'oferecer', 'proposta', 'produto', 'servi√ßo', 'sistema'];
            const benefitWords = ['benef√≠cio', 'vantagem', 'resultado', 'melhoria', 'economia', 'ganho', 'otimiza√ß√£o'];
            const valueWords = ['valor', 'retorno', 'investimento', 'custo', 'pre√ßo'];
            
            const hasSolutionWords = solutionWords.some(word => transcript.includes(word));
            const hasBenefits = benefitWords.some(word => transcript.includes(word));
            const hasValueProposition = valueWords.some(word => transcript.includes(word));
            
            let solutionScore = 0;
            if (hasSolutionWords) solutionScore += 4;
            if (hasBenefits) solutionScore += 3;
            if (hasValueProposition) solutionScore += 2;
            solutionScore += durationMinutes > 5 ? 1 : 0;
            solutionScore = Math.min(10, solutionScore);
            
            // CRIT√âRIO 4: TRATAMENTO DE OBJE√á√ïES
            const objectionWords = ['mas', 'por√©m', 'entretanto', 'n√£o sei', 'dif√≠cil', 'caro', 'problema', 'preocupa√ß√£o'];
            const handlingWords = ['entendo', 'compreendo', 'vamos', 'podemos', 'uma alternativa', 'outra op√ß√£o', 'vou explicar'];
            
            const objectionCount = objectionWords.filter(word => transcript.includes(word)).length;
            const handlingCount = handlingWords.filter(word => transcript.includes(word)).length;
            
            let objectionScore = 7;
            if (objectionCount > 0) {
                objectionScore = handlingCount >= objectionCount ? 9 : Math.max(4, 8 - objectionCount);
            }
            objectionScore = Math.min(10, objectionScore);
            
            // CRIT√âRIO 5: FECHAMENTO E PR√ìXIMOS PASSOS
            const nextStepWords = ['pr√≥ximo', 'agendar', 'retorno', 'contato', 'follow', 'reuni√£o', 'encontro', 'conversar'];
            const closingWords = ['obrigad', 'at√© logo', 'at√© mais', 'tchau', 'abra√ßo', 'tenha um', '√≥timo dia'];
            const urgencyWords = ['urgente', 'r√°pido', 'hoje', 'amanh√£', 'esta semana'];
            
            const hasNextSteps = nextStepWords.some(word => transcript.includes(word));
            const hasClosing = closingWords.some(word => transcript.includes(word));
            const hasUrgency = urgencyWords.some(word => transcript.includes(word));
            
            let closingScore = 0;
            if (hasNextSteps) closingScore += 5;
            if (hasClosing) closingScore += 3;
            if (hasUrgency) closingScore += 1;
            closingScore += durationMinutes > 2 ? 1 : 0;
            closingScore = Math.min(10, closingScore);
            
            // GERA√á√ÉO DE JUSTIFICATIVAS INTELIGENTES
            const criteria = [
                {
                    id: 1,
                    score: openingScore,
                    justification: (() => {
                        if (openingScore >= 9) {
                            return `üåü Abertura excepcional! ${hasGreeting ? 'Cumprimentou adequadamente' : ''} ${hasIntroduction ? 'e se apresentou profissionalmente' : ''}. ${hasCompanyMention ? 'Mencionou a empresa do cliente, demonstrando personaliza√ß√£o.' : ''}`;
                        } else if (openingScore >= 7) {
                            return `‚úÖ Boa abertura. ${!hasGreeting ? 'Poderia cumprimentar de forma mais calorosa.' : ''} ${!hasIntroduction ? 'Faltou apresenta√ß√£o clara.' : ''} ${!hasCompanyMention ? 'Considere mencionar o nome da empresa.' : ''}`;
                        } else if (openingScore >= 5) {
                            return `‚ö†Ô∏è Abertura b√°sica. ${!hasGreeting ? 'Faltou cumprimento inicial.' : ''} ${!hasIntroduction ? 'N√£o se apresentou adequadamente.' : ''} Importante criar conex√£o desde o in√≠cio.`;
                        } else {
                            return `‚ùå Abertura precisa melhorar significativamente. Essencial: cumprimentar, apresentar-se e mencionar a empresa do cliente.`;
                        }
                    })()
                },
                {
                    id: 2,
                    score: needsScore,
                    justification: (() => {
                        if (needsScore >= 8) {
                            return `üéØ Excelente descoberta! Fez ${questionMarks} perguntas e usou ${needsWords} palavras-chave de explora√ß√£o. Demonstrou genu√≠no interesse em entender o cliente.`;
                        } else if (needsScore >= 6) {
                            return `üëç Boa explora√ß√£o com ${questionMarks} perguntas. Poderia aprofundar mais nas necessidades espec√≠ficas e desafios do ${company}.`;
                        } else if (needsScore >= 4) {
                            return `üìã Explora√ß√£o b√°sica. Fez algumas perguntas, mas precisa ser mais investigativo para identificar oportunidades reais.`;
                        } else {
                            return `üîç Faltou explora√ß√£o de necessidades. Crucial fazer mais perguntas sobre problemas, desafios e objetivos do cliente.`;
                        }
                    })()
                },
                {
                    id: 3,
                    score: solutionScore,
                    justification: (() => {
                        if (solutionScore >= 8) {
                            return `üí° Apresenta√ß√£o excelente! ${hasSolutionWords ? 'Explicou a solu√ß√£o claramente' : ''} ${hasBenefits ? 'e destacou benef√≠cios espec√≠ficos' : ''} ${hasValueProposition ? 'com proposta de valor definida' : ''}.`;
                        } else if (solutionScore >= 6) {
                            return `üìä Boa apresenta√ß√£o. ${!hasBenefits ? 'Poderia destacar mais os benef√≠cios espec√≠ficos para ' + company + '.' : ''} ${!hasValueProposition ? 'Faltou abordar valor/ROI.' : ''}`;
                        } else if (solutionScore >= 4) {
                            return `üìù Apresenta√ß√£o b√°sica. ${!hasSolutionWords ? 'Faltou explicar claramente a solu√ß√£o.' : ''} Importante conectar features com benef√≠cios.`;
                        } else {
                            return `‚ùå N√£o apresentou solu√ß√£o adequadamente. Essencial explicar como resolve os problemas identificados.`;
                        }
                    })()
                },
                {
                    id: 4,
                    score: objectionScore,
                    justification: (() => {
                        if (objectionCount === 0) {
                            return `‚ú® Chamada fluiu bem sem obje√ß√µes significativas. Continue sendo proativo para antecipar poss√≠veis preocupa√ß√µes.`;
                        } else if (handlingCount >= objectionCount) {
                            return `üõ°Ô∏è Excelente manejo de obje√ß√µes! Identificou ${objectionCount} obje√ß√£o(√µes) e tratou com ${handlingCount} t√©cnica(s) de resolu√ß√£o. Demonstrou empatia e solu√ß√µes.`;
                        } else if (handlingCount > 0) {
                            return `‚öñÔ∏è Cliente apresentou ${objectionCount} obje√ß√£o(√µes), tratou ${handlingCount} adequadamente. Poderia ser mais assertivo nas demais.`;
                        } else {
                            return `üö® Cliente apresentou ${objectionCount} obje√ß√£o(√µes) sem tratamento adequado. Importante usar t√©cnicas de empatia e resolu√ß√£o.`;
                        }
                    })()
                },
                {
                    id: 5,
                    score: closingScore,
                    justification: (() => {
                        if (closingScore >= 8) {
                            return `üéØ Fechamento perfeito! ${hasNextSteps ? 'Definiu pr√≥ximos passos claros' : ''} ${hasClosing ? 'e encerrou profissionalmente' : ''} ${hasUrgency ? 'com senso de urg√™ncia' : ''}.`;
                        } else if (closingScore >= 6) {
                            return `üëç Bom fechamento. ${!hasNextSteps ? 'Poderia ter definido pr√≥ximos passos mais espec√≠ficos.' : ''} ${!hasClosing ? 'Faltou encerramento cordial.' : ''}`;
                        } else if (closingScore >= 4) {
                            return `üìÖ Fechamento b√°sico. ${!hasNextSteps ? 'Faltou agendar follow-up espec√≠fico.' : ''} Importante sempre definir pr√≥ximas a√ß√µes.`;
                        } else {
                            return `‚ùå Fechamento inadequado. Essencial definir pr√≥ximos passos claros e agendar retorno espec√≠fico.`;
                        }
                    })()
                }
            ];
            
            // C√ÅLCULO DO SCORE FINAL PONDERADO
            const weights = [15, 25, 20, 20, 20];
            let totalWeighted = 0;
            let totalWeight = 0;
            
            criteria.forEach((criterion, index) => {
                const weight = weights[index];
                totalWeighted += criterion.score * weight;
                totalWeight += weight;
            });
            
            const finalScore = Math.round(totalWeighted / totalWeight);
            
            // AN√ÅLISE ADICIONAL E INSIGHTS
            const qualityIndicators = {
                transcriptionQuality: transcription.length > 100 ? 'alta' : transcription.length > 50 ? 'm√©dia' : 'baixa',
                callDuration: durationMinutes >= 5 ? 'adequada' : durationMinutes >= 2 ? 'curta' : 'muito curta',
                engagementLevel: questionMarks >= 3 ? 'alto' : questionMarks >= 1 ? 'm√©dio' : 'baixo',
                professionalismLevel: (hasGreeting && hasIntroduction && hasClosing) ? 'alto' : 'm√©dio'
            };
            
            return {
                finalScore,
                criteria,
                analysis: {
                    transcriptionLength: transcription.length,
                    durationMinutes,
                    company,
                    questionsCount: questionMarks,
                    qualityIndicators,
                    insights: insights || {}
                }
            };
        }

        // DADOS DE TESTE SIMULANDO CHAMADAS REAIS
        const testCalls = {
            complete: {
                transcription: `Bom dia! Meu nome √© Jo√£o Silva do Grupo GGV. Estou entrando em contato com a TechCorp para falar sobre solu√ß√µes de vendas.
                
Qual √© o principal desafio que voc√™s enfrentam no processo de vendas atualmente? 
Como voc√™s fazem o acompanhamento dos leads hoje?
Voc√™s t√™m alguma meta espec√≠fica de crescimento para este trimestre?

Nossa solu√ß√£o pode ajudar a aumentar a taxa de convers√£o em at√© 40% atrav√©s de automa√ß√£o inteligente. 
O benef√≠cio principal √© a economia de tempo da equipe e melhoria nos resultados.
O retorno do investimento √© vis√≠vel j√° no primeiro m√™s.

Entendo sua preocupa√ß√£o com o custo, mas vamos analisar o valor que isso pode gerar.
Podemos agendar uma reuni√£o esta semana para mostrar uma demonstra√ß√£o?
Obrigado pelo tempo e at√© breve!`,
                duration: 420,
                company: 'TechCorp',
                recording_url: 'https://drive.google.com/file/d/1234567890/view',
                insights: { company: 'TechCorp', segment: 'Technology' }
            },
            
            noTranscription: {
                transcription: '',
                duration: 180,
                company: 'StartupXYZ',
                recording_url: 'https://drive.google.com/file/d/0987654321/view',
                insights: { company: 'StartupXYZ' }
            },
            
            short: {
                transcription: `Oi, √© da StartupABC? Sou do Grupo GGV. Voc√™s precisam de ajuda com vendas?`,
                duration: 45,
                company: 'StartupABC',
                recording_url: null,
                insights: {}
            },
            
            detailed: {
                transcription: `Boa tarde! Meu nome √© Maria Santos, sou consultora comercial do Grupo GGV Intelig√™ncia em Vendas.
                
Estou entrando em contato com a InnovaCorp porque identificamos que voc√™s podem se beneficiar muito das nossas solu√ß√µes.
Como est√° funcionando o processo de vendas de voc√™s hoje? Quais s√£o os principais gargalos?
Voc√™s t√™m alguma meta espec√≠fica de crescimento? Qual o principal desafio para atingir essas metas?
Como voc√™s fazem o follow-up dos prospects? T√™m algum sistema de CRM?

Entendo perfeitamente. Muitas empresas passam por isso.
Nossa solu√ß√£o de automa√ß√£o pode resolver exatamente esse problema.
Oferecemos um sistema completo que vai desde a gera√ß√£o de leads at√© o fechamento.
Os benef√≠cios incluem aumento de 40% na convers√£o, economia de 60% do tempo da equipe.
O retorno do investimento √© garantido em 30 dias.

Mas isso √© muito caro para n√≥s agora...
Entendo sua preocupa√ß√£o. Vamos ver uma alternativa que se encaixe no seu or√ßamento.
Podemos come√ßar com um projeto piloto menor, com investimento reduzido.

Perfeito! Vou agendar uma reuni√£o para pr√≥xima ter√ßa-feira √†s 14h.
Vou enviar o material por email hoje ainda.
Muito obrigada pelo seu tempo e at√© ter√ßa!`,
                duration: 480,
                company: 'InnovaCorp',
                recording_url: 'https://drive.google.com/file/d/1122334455/view',
                insights: { 
                    company: 'InnovaCorp', 
                    segment: 'Innovation',
                    leadScore: 8,
                    budget: 'medium'
                }
            }
        };

        function displayResult(elementId, result, title) {
            const element = document.getElementById(elementId);
            const scoreClass = result.finalScore >= 8 ? 'success' : result.finalScore >= 6 ? 'warning' : result.finalScore >= 4 ? 'info' : 'error';
            
            let html = `<div class="result ${scoreClass}">
                <h4>${title}</h4>
                <p><strong>Score Final:</strong> ${result.finalScore}/10</p>
                <p><strong>Dura√ß√£o:</strong> ${result.analysis.durationMinutes} minutos</p>
                <p><strong>Qualidade da Transcri√ß√£o:</strong> ${result.analysis.qualityIndicators.transcriptionQuality}</p>
                <p><strong>N√≠vel de Engajamento:</strong> ${result.analysis.qualityIndicators.engagementLevel}</p>
            </div>`;
            
            if (result.criteria) {
                html += '<div class="criteria-grid">';
                result.criteria.forEach(criterion => {
                    const criterionClass = criterion.score >= 8 ? 'score-high' : criterion.score >= 6 ? 'score-medium' : 'score-low';
                    html += `<div class="criterion ${criterionClass}">
                        <strong>Crit√©rio ${criterion.id}: ${criterion.score}/10</strong>
                        <p style="margin: 8px 0; font-size: 14px;">${criterion.justification}</p>
                    </div>`;
                });
                html += '</div>';
            }
            
            element.innerHTML = html;
        }

        // FUN√á√ïES DE TESTE
        function testCompleteCall() {
            console.log('üß™ Executando Teste 1: Chamada Completa');
            const call = testCalls.complete;
            const result = analyzeCallContent(call.transcription, call.duration, call.company, call.insights);
            displayResult('result1', result, '‚úÖ Chamada Completa - Score Alto Esperado');
        }

        function testCallWithoutTranscription() {
            console.log('üß™ Executando Teste 2: Sem Transcri√ß√£o');
            const call = testCalls.noTranscription;
            
            if (!call.transcription) {
                const element = document.getElementById('result2');
                element.innerHTML = `<div class="result error">
                    <h4>‚ùå Transcri√ß√£o N√£o Dispon√≠vel</h4>
                    <p>Esta chamada possui √°udio mas n√£o foi transcrita ainda.</p>
                    <p><strong>Dura√ß√£o:</strong> ${Math.floor(call.duration / 60)} minutos</p>
                    <p><strong>Status:</strong> Aguardando processamento</p>
                    <p><strong>A√ß√£o:</strong> An√°lise ser√° executada ap√≥s transcri√ß√£o</p>
                </div>`;
                return;
            }
            
            const result = analyzeCallContent(call.transcription, call.duration, call.company, call.insights);
            displayResult('result2', result, '‚ö†Ô∏è Sem Transcri√ß√£o - Erro Esperado');
        }

        function testShortCall() {
            console.log('üß™ Executando Teste 3: Chamada Curta');
            const call = testCalls.short;
            const result = analyzeCallContent(call.transcription, call.duration, call.company, call.insights);
            displayResult('result3', result, '‚è±Ô∏è Chamada Curta - Score Baixo Esperado');
        }

        function testDetailedScorecard() {
            console.log('üß™ Executando Teste 4: Scorecard Detalhado');
            const call = testCalls.detailed;
            const result = analyzeCallContent(call.transcription, call.duration, call.company, call.insights);
            displayResult('result4', result, 'üéØ An√°lise Detalhada - Score Muito Alto Esperado');
        }

        function testAudioIntegration() {
            console.log('üß™ Executando Teste 5: Integra√ß√£o com √Åudio');
            const call = testCalls.complete;
            
            // Simular convers√£o de URL do Google Drive
            function convertGoogleDriveUrl(url) {
                if (url && url.includes('drive.google.com')) {
                    const fileIdMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                    if (fileIdMatch) {
                        return `https://drive.google.com/uc?export=download&id=${fileIdMatch[1]}`;
                    }
                }
                return url;
            }
            
            const convertedUrl = convertGoogleDriveUrl(call.recording_url);
            
            const element = document.getElementById('result5');
            element.innerHTML = `<div class="result success">
                <h4>üéß Integra√ß√£o com √Åudio Funcionando</h4>
                <p><strong>URL Original:</strong> ${call.recording_url}</p>
                <p><strong>URL Convertida:</strong> ${convertedUrl}</p>
                <p><strong>Status:</strong> ‚úÖ Pronto para reprodu√ß√£o</p>
                <p><strong>Dura√ß√£o:</strong> ${Math.floor(call.duration / 60)}:${String(call.duration % 60).padStart(2, '0')}</p>
                <audio controls style="width: 100%; margin: 10px 0;">
                    <source src="${convertedUrl}" type="audio/mpeg">
                    Seu navegador n√£o suporta o elemento de √°udio.
                </audio>
                <p style="font-size: 12px; color: #666;">
                    Nota: Este √© um teste simulado. Em produ√ß√£o, o √°udio seria carregado do Google Drive.
                </p>
            </div>`;
        }

        // Executar teste inicial ao carregar a p√°gina
        console.log('üöÄ Sistema de An√°lise de Chamadas - Testes Carregados');
        console.log('üìä Fun√ß√£o analyzeCallContent implementada com sucesso');
        console.log('üéØ Pronto para testes com dados reais');
    </script>
</body>
</html>
