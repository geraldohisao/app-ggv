<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Credenciais Corretas</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .error { background: #fee2e2; color: #dc2626; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .success { background: #dcfce7; color: #166534; padding: 15px; border-radius: 6px; margin: 10px 0; }
        .info { background: #dbeafe; color: #1e40af; padding: 15px; border-radius: 6px; margin: 10px 0; }
        button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin: 5px; }
        pre { background: #f9fafb; padding: 15px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; }
        .test-result { border: 1px solid #e5e7eb; margin: 10px 0; padding: 15px; border-radius: 6px; }
    </style>
</head>
<body>
    <h1>‚úÖ Teste - Credenciais Corretas</h1>
    
    <div class="container">
        <div class="info">
            <strong>üéØ PROJETO CORRETO IDENTIFICADO:</strong><br>
            <strong>ID:</strong> mwlekwyxbfbxfxskywgx<br>
            <strong>URL:</strong> https://mwlekwyxbfbxfxskywgx.supabase.co<br>
            <strong>Anon Key:</strong> eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13bGVrd3l4YmZieGZ4c2t5d2d4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMTIzMjEsImV4cCI6MjA2NTY4ODMyMX0.rFX9H2pcGLNX7n3vKLYGi72JKwjUw6oG38IZGjO90HE
        </div>
        
        <button onclick="testConnection()">1. Testar Conex√£o</button>
        <button onclick="testTableAccess()">2. Testar Acesso √† Tabela</button>
        <button onclick="testRPCFunctions()">3. Testar Fun√ß√µes RPC</button>
        <button onclick="runFullTest()">4. Teste Completo</button>
        <div id="result"></div>
    </div>

    <script>
        // CREDENCIAIS CORRETAS
        const supabaseUrl = 'https://mwlekwyxbfbxfxskywgx.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13bGVrd3l4YmZieGZ4c2t5d2d4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTAxMTIzMjEsImV4cCI6MjA2NTY4ODMyMX0.rFX9H2pcGLNX7n3vKLYGi72JKwjUw6oG38IZGjO90HE';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        function showResult(html) {
            document.getElementById('result').innerHTML = html;
        }

        async function testConnection() {
            showResult('<div class="info">üîç Testando conex√£o com credenciais corretas...</div>');
            
            try {
                const { data, error } = await supabase.auth.getSession();
                
                if (error) {
                    showResult(`
                        <div class="test-result">
                            <div class="error">‚ùå ERRO DE CONEX√ÉO</div>
                            <pre>${JSON.stringify(error, null, 2)}</pre>
                        </div>
                    `);
                } else {
                    showResult(`
                        <div class="test-result">
                            <div class="success">‚úÖ CONEX√ÉO OK</div>
                            <div>URL: ${supabaseUrl}</div>
                            <div>Status: Conectado com sucesso</div>
                        </div>
                    `);
                }
            } catch (err) {
                showResult(`
                    <div class="test-result">
                        <div class="error">üí• ERRO INESPERADO</div>
                        <pre>${err.message}</pre>
                    </div>
                `);
            }
        }

        async function testTableAccess() {
            showResult('<div class="info">üîç Testando acesso √† tabela calls...</div>');
            
            try {
                const { data, error, count } = await supabase
                    .from('calls')
                    .select('id, agent_id, deal_id, status, created_at', { count: 'exact' })
                    .limit(5);

                if (error) {
                    showResult(`
                        <div class="test-result">
                            <div class="error">‚ùå ERRO NO ACESSO √Ä TABELA</div>
                            <div>C√≥digo: ${error.code}</div>
                            <div>Mensagem: ${error.message}</div>
                            <div>Detalhes: ${error.details}</div>
                            <div>Hint: ${error.hint}</div>
                        </div>
                    `);
                } else {
                    showResult(`
                        <div class="test-result">
                            <div class="success">‚úÖ TABELA CALLS ACESS√çVEL</div>
                            <div>Total de registros: ${count}</div>
                            <div>Registros retornados: ${data.length}</div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `);
                }
            } catch (err) {
                showResult(`
                    <div class="test-result">
                        <div class="error">üí• ERRO INESPERADO</div>
                        <pre>${err.message}</pre>
                    </div>
                `);
            }
        }

        async function testRPCFunctions() {
            showResult('<div class="info">üîç Testando fun√ß√µes RPC...</div>');
            
            const functions = [
                { name: 'get_dashboard_metrics', params: { p_days: 14 } },
                { name: 'get_calls_with_filters', params: { p_limit: 5, p_offset: 0 } },
                { name: 'get_unique_sdrs', params: {} }
            ];

            let html = '<div class="info">üìã Resultados das Fun√ß√µes RPC:</div>';

            for (const func of functions) {
                try {
                    console.log(`Testando ${func.name}...`);
                    const { data, error } = await supabase.rpc(func.name, func.params);
                    
                    if (error) {
                        if (error.code === '42883') {
                            html += `<div class="test-result">
                                <div class="error">‚ùå ${func.name}</div>
                                <div>FUN√á√ÉO N√ÉO EXISTE (c√≥digo 42883)</div>
                                <div>Precisa executar o script SQL primeiro!</div>
                            </div>`;
                        } else {
                            html += `<div class="test-result">
                                <div class="error">‚ö†Ô∏è ${func.name}</div>
                                <div>ERRO: ${error.message}</div>
                                <div>C√≥digo: ${error.code}</div>
                            </div>`;
                        }
                    } else {
                        html += `<div class="test-result">
                            <div class="success">‚úÖ ${func.name}</div>
                            <div>FUNCIONANDO - ${Array.isArray(data) ? data.length : 1} resultado(s)</div>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>`;
                    }
                } catch (err) {
                    html += `<div class="test-result">
                        <div class="error">üí• ${func.name}</div>
                        <div>ERRO INESPERADO: ${err.message}</div>
                    </div>`;
                }
            }

            showResult(html);
        }

        async function runFullTest() {
            showResult('<div class="info">üîç Executando teste completo...</div>');
            
            let html = '<div class="info">üìã Teste Completo do Sistema:</div>';

            // Teste 1: Conex√£o
            try {
                const { data, error } = await supabase.auth.getSession();
                html += `<div class="test-result">
                    <div class="${error ? 'error' : 'success'}">${error ? '‚ùå' : '‚úÖ'} Conex√£o</div>
                    ${error ? `<div>Erro: ${error.message}</div>` : '<div>Conectado com sucesso</div>'}
                </div>`;
            } catch (err) {
                html += `<div class="test-result">
                    <div class="error">‚ùå Conex√£o</div>
                    <div>Erro: ${err.message}</div>
                </div>`;
            }

            // Teste 2: Tabela calls
            try {
                const { data, error, count } = await supabase
                    .from('calls')
                    .select('*', { count: 'exact', head: true });

                html += `<div class="test-result">
                    <div class="${error ? 'error' : 'success'}">${error ? '‚ùå' : '‚úÖ'} Tabela calls</div>
                    ${error ? `<div>Erro: ${error.message}</div>` : `<div>${count} registros encontrados</div>`}
                </div>`;
            } catch (err) {
                html += `<div class="test-result">
                    <div class="error">‚ùå Tabela calls</div>
                    <div>Erro: ${err.message}</div>
                </div>`;
            }

            // Teste 3: Fun√ß√µes RPC
            const rpcFunctions = ['get_dashboard_metrics', 'get_calls_with_filters', 'get_unique_sdrs'];
            
            for (const funcName of rpcFunctions) {
                try {
                    const params = funcName === 'get_dashboard_metrics' ? { p_days: 7 } : 
                                  funcName === 'get_calls_with_filters' ? { p_limit: 3, p_offset: 0 } : {};
                    
                    const { data, error } = await supabase.rpc(funcName, params);
                    
                    html += `<div class="test-result">
                        <div class="${error ? 'error' : 'success'}">${error ? '‚ùå' : '‚úÖ'} ${funcName}</div>
                        ${error ? `<div>Erro: ${error.message}</div>` : `<div>Funcionando - ${Array.isArray(data) ? data.length : 1} resultado(s)</div>`}
                    </div>`;
                } catch (err) {
                    html += `<div class="test-result">
                        <div class="error">‚ùå ${funcName}</div>
                        <div>Erro: ${err.message}</div>
                    </div>`;
                }
            }

            showResult(html);
        }

        // Auto-executar teste de conex√£o ao carregar
        window.onload = function() {
            console.log('üîç Testando credenciais corretas');
            testConnection();
        };
    </script>
</body>
</html>
