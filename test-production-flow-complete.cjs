#!/usr/bin/env node

/**
 * üéØ TESTE COMPLETO DO FLUXO DE PRODU√á√ÉO - Deal ID 62719
 * 
 * Simula exatamente o que acontece em produ√ß√£o:
 * 1. Update Deal Fields (pode falhar, mas n√£o bloqueia)
 * 2. Diagn√≥stico Completo (deve sempre funcionar)
 */

const https = require('https');

const DEAL_ID = '62719';
const BASE_URL = 'https://api-test.ggvinteligencia.com.br/webhook/diag-ggv-register';

function makeRequest(url, options = {}) {
    return new Promise((resolve, reject) => {
        const urlObj = new URL(url);
        
        const requestOptions = {
            hostname: urlObj.hostname,
            port: 443,
            path: urlObj.pathname + urlObj.search,
            method: options.method || 'GET',
            headers: {
                'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36',
                'Accept': '*/*',
                'Content-Type': 'application/json',
                'Origin': 'https://app.grupoggv.com',
                'Referer': 'https://app.grupoggv.com/',
                ...options.headers
            },
            timeout: 15000
        };
        
        const req = https.request(requestOptions, (res) => {
            let data = '';
            res.on('data', (chunk) => data += chunk);
            res.on('end', () => {
                resolve({
                    status: res.statusCode,
                    statusText: res.statusMessage,
                    headers: res.headers,
                    body: data
                });
            });
        });
        
        req.on('error', reject);
        req.on('timeout', () => {
            req.destroy();
            reject(new Error('Request timeout'));
        });
        
        if (options.body) {
            req.write(options.body);
        }
        
        req.end();
    });
}

// Simular exatamente o fluxo de produ√ß√£o
async function testProductionFlow() {
    console.log('üéØ TESTE COMPLETO DO FLUXO DE PRODU√á√ÉO');
    console.log('=' .repeat(60));
    
    const results = {
        updateFields: null,
        diagnosticComplete: null,
        flowSuccess: false
    };
    
    // ETAPA 1: Update Deal Fields (formato melhorado com fallback)
    console.log('\nüìù ETAPA 1: UPDATE DEAL FIELDS');
    console.log('-'.repeat(40));
    
    try {
        // Estrat√©gia 1: Formato simplificado
        const simplePayload = {
            action: 'update_deal_fields',
            deal_id: DEAL_ID,
            timestamp: new Date().toISOString(),
            
            companyData: {
                companyName: "Construtora Ikigai",
                email: "Grupokondo@gmail.com",
                activityBranch: "Servi√ßo",
                monthlyBilling: "Acima de R$ 1 milh√£o/m√™s",
                salesTeamSize: "De 1 a 3 colaboradores",
                salesChannels: ["Inside Sales", "Distribuidores"],
                activitySector: "Im√≥veis / Arquitetura / Constru√ß√£o civil",
                situacao: "Construtora em Curitiba que faz casas de alto padr√£o, ele presta o servi√ßo para quem quer a pr√≥pria casa e agora est√° entrando no mercado de incorpora√ß√£o\n\nQuer apoio para estruturar os processos, meetime e pipedrive na construtora.\nteste3",
                problema: "Recebe um volume de leads e recentemente n√£o est√° convertendo. Est√° contratando 1 vendedor e 2 SDR`s. \nteste 3",
                perfil_do_cliente: "teste perfil do cliente v2\n\nteste4",
                dealId: DEAL_ID
            },
            
            clientContext: {
                situacao: "Construtora em Curitiba que faz casas de alto padr√£o, ele presta o servi√ßo para quem quer a pr√≥pria casa e agora est√° entrando no mercado de incorpora√ß√£o\n\nQuer apoio para estruturar os processos, meetime e pipedrive na construtora.\nteste3",
                problema: "Recebe um volume de leads e recentemente n√£o est√° convertendo. Est√° contratando 1 vendedor e 2 SDR`s. \nteste 3",
                perfil_do_cliente: "teste perfil do cliente v2\n\nteste4"
            },
            
            source: 'ggv-diagnostic-update',
            version: 'update-fields-v2'
        };
        
        console.log('üîÑ Tentativa 1: Formato simplificado');
        let response = await makeRequest(BASE_URL, {
            method: 'POST',
            headers: {
                'X-Request-Type': 'update-fields'
            },
            body: JSON.stringify(simplePayload)
        });
        
        if (response.status >= 200 && response.status < 300) {
            console.log('‚úÖ Update Fields - Sucesso com formato simplificado');
            results.updateFields = { success: true, strategy: 'simplified', status: response.status };
        } else {
            console.log('‚ö†Ô∏è Formato simplificado falhou, tentando formato original...');
            
            // Estrat√©gia 2: Formato original
            const originalPayload = {
                action: 'update_deal_fields',
                source: 'ggv-diagnostic-company-form',
                dealId: DEAL_ID,
                changedFields: {
                    perfil_do_cliente: "teste perfil do cliente v2\n\nteste4",
                    monthlyBilling: "Acima de R$ 1 milh√£o/m√™s",
                    salesChannels: ["Inside Sales", "Distribuidores"]
                },
                formData: {
                    companyName: "Construtora Ikigai",
                    email: "Grupokondo@gmail.com",
                    activityBranch: "Servi√ßo",
                    monthlyBilling: "Acima de R$ 1 milh√£o/m√™s",
                    salesTeamSize: "De 1 a 3 colaboradores",
                    salesChannels: ["Inside Sales", "Distribuidores"],
                    activitySector: "Im√≥veis / Arquitetura / Constru√ß√£o civil",
                    situacao: "Construtora em Curitiba que faz casas de alto padr√£o, ele presta o servi√ßo para quem quer a pr√≥pria casa e agora est√° entrando no mercado de incorpora√ß√£o\n\nQuer apoio para estruturar os processos, meetime e pipedrive na construtora.\nteste3",
                    problema: "Recebe um volume de leads e recentemente n√£o est√° convertendo. Est√° contratando 1 vendedor e 2 SDR`s. \nteste 3",
                    perfil_do_cliente: "teste perfil do cliente v2\n\nteste4"
                },
                clientContext: {
                    situacao: "Construtora em Curitiba que faz casas de alto padr√£o, ele presta o servi√ßo para quem quer a pr√≥pria casa e agora est√° entrando no mercado de incorpora√ß√£o\n\nQuer apoio para estruturar os processos, meetime e pipedrive na construtora.\nteste3",
                    problema: "Recebe um volume de leads e recentemente n√£o est√° convertendo. Est√° contratando 1 vendedor e 2 SDR`s. \nteste 3",
                    perfil_do_cliente: "teste perfil do cliente v2\n\nteste4"
                },
                timestamp: new Date().toISOString()
            };
            
            console.log('üîÑ Tentativa 2: Formato original');
            response = await makeRequest(BASE_URL, {
                method: 'POST',
                headers: {
                    'X-Request-Type': 'update-fields-fallback'
                },
                body: JSON.stringify(originalPayload)
            });
            
            if (response.status >= 200 && response.status < 300) {
                console.log('‚úÖ Update Fields - Sucesso com formato original');
                results.updateFields = { success: true, strategy: 'original', status: response.status };
            } else {
                console.log('‚ö†Ô∏è Update Fields - Ambos formatos falharam, mas continuando...');
                results.updateFields = { success: false, strategy: 'both_failed', status: response.status, body: response.body };
            }
        }
        
    } catch (error) {
        console.log('‚ùå Update Fields - Erro de rede:', error.message);
        results.updateFields = { success: false, error: error.message };
    }
    
    // Aguardar entre etapas
    console.log('\n‚è≥ Aguardando 2 segundos antes do diagn√≥stico principal...');
    await new Promise(resolve => setTimeout(resolve, 2000));
    
    // ETAPA 2: Diagn√≥stico Completo (DEVE SEMPRE FUNCIONAR)
    console.log('\nüéØ ETAPA 2: DIAGN√ìSTICO COMPLETO');
    console.log('-'.repeat(40));
    
    try {
        const diagnosticPayload = {
            deal_id: DEAL_ID,
            timestamp: new Date().toISOString(),
            action: 'ai_analysis_completed',
            
            body: {
                results: {
                    maturityPercentage: 22
                },
                resultUrl: `https://app.grupoggv.com/r/prod-flow-test-${DEAL_ID}-${Date.now()}`,
                deal_id: DEAL_ID,
                
                aiAnalysis: {
                    summaryInsights: {
                        specialistInsight: "A Construtora Ikigai apresenta um cen√°rio de crescimento, com faturamento acima de R$ 1 milh√£o/m√™s, mas enfrenta desafios na convers√£o de leads. A expans√£o para o mercado de incorpora√ß√µes exige maior estrutura√ß√£o comercial.",
                        recommendations: [
                            "Implementar CRM robusto",
                            "Definir metas claras",
                            "Estruturar processo de follow-up",
                            "Treinar equipe comercial"
                        ]
                    },
                    detailedAnalysis: {
                        strengths: [
                            "Faturamento acima de R$ 1 milh√£o/m√™s",
                            "Presen√ßa em mercado promissor",
                            "Expans√£o para incorpora√ß√£o"
                        ],
                        improvements: [
                            "Estrutura√ß√£o de processos",
                            "Melhoria na convers√£o",
                            "Amplia√ß√£o de equipe"
                        ],
                        nextSteps: [
                            "Implementar CRM",
                            "Treinar equipe",
                            "Definir m√©tricas"
                        ]
                    }
                },
                
                diagnosticAnswers: [
                    {
                        questionId: 1,
                        question: "Voc√™ j√° realizou o mapeamento de processos da √°rea comercial?",
                        answer: "Parcialmente",
                        description: "Alguns processos mapeados, mas n√£o todos",
                        score: 5
                    },
                    {
                        questionId: 2,
                        question: "Voc√™ utiliza algum sistema de CRM?",
                        answer: "Parcialmente",
                        description: "Tem CRM mas n√£o √© usado consistentemente",
                        score: 5
                    },
                    {
                        questionId: 3,
                        question: "Voc√™ tem um script comercial redigido e seguido pelo seu time de vendas?",
                        answer: "Parcialmente",
                        description: "Script existe, mas n√£o √© seguido por todos",
                        score: 5
                    },
                    {
                        questionId: 4,
                        question: "Seu time de vendas j√° realizou algum teste de perfil comportamental?",
                        answer: "Parcialmente",
                        description: "Apenas alguns membros foram avaliados",
                        score: 5
                    },
                    {
                        questionId: 5,
                        question: "Voc√™ tem um plano de metas e comissionamento para o setor comercial?",
                        answer: "N√£o",
                        description: "N√£o possui plano estruturado",
                        score: 0
                    }
                ]
            },
            
            companyData: {
                companyName: "Construtora Ikigai",
                email: "Grupokondo@gmail.com",
                activityBranch: "Servi√ßo",
                monthlyBilling: "Acima de R$ 1 milh√£o/m√™s",
                salesTeamSize: "De 1 a 3 colaboradores",
                salesChannels: ["Inside Sales", "Distribuidores"]
            },
            
            clientContext: {
                situacao: "Construtora em Curitiba que faz casas de alto padr√£o, ele presta o servi√ßo para quem quer a pr√≥pria casa e agora est√° entrando no mercado de incorpora√ß√£o\n\nQuer apoio para estruturar os processos, meetime e pipedrive na construtora.\nteste3",
                problema: "Recebe um volume de leads e recentemente n√£o est√° convertendo. Est√° contratando 1 vendedor e 2 SDR`s. \nteste 3",
                perfil_do_cliente: "teste perfil do cliente v2\n\nteste4"
            },
            
            segment: {
                name: "Geral",
                id: "gen_1"
            },
            
            source: "web-diagnostic",
            version: "production-flow-test"
        };
        
        console.log('üöÄ Enviando diagn√≥stico completo...');
        const response = await makeRequest(BASE_URL, {
            method: 'POST',
            body: JSON.stringify(diagnosticPayload)
        });
        
        console.log(`üìä Status: ${response.status} ${response.statusText}`);
        console.log(`üìä Body: ${response.body}`);
        
        if (response.status >= 200 && response.status < 300) {
            console.log('‚úÖ Diagn√≥stico Completo - SUCESSO!');
            results.diagnosticComplete = { success: true, status: response.status, body: response.body };
            results.flowSuccess = true; // O que importa √© o diagn√≥stico principal
        } else {
            console.log('‚ùå Diagn√≥stico Completo - FALHOU!');
            results.diagnosticComplete = { success: false, status: response.status, body: response.body };
        }
        
    } catch (error) {
        console.log('‚ùå Diagn√≥stico Completo - Erro:', error.message);
        results.diagnosticComplete = { success: false, error: error.message };
    }
    
    return results;
}

async function runProductionFlowTest() {
    console.log('üéØ TESTE COMPLETO DO FLUXO DE PRODU√á√ÉO - Deal 62719\n');
    
    const results = await testProductionFlow();
    
    // An√°lise dos resultados
    console.log('\n' + '='.repeat(70));
    console.log('üìã RESUMO DO FLUXO DE PRODU√á√ÉO');
    console.log('='.repeat(70));
    
    console.log(`üìù Update Fields: ${results.updateFields?.success ? '‚úÖ SUCESSO' : '‚ö†Ô∏è FALHOU'} ${results.updateFields?.strategy ? `(${results.updateFields.strategy})` : ''}`);
    console.log(`üéØ Diagn√≥stico: ${results.diagnosticComplete?.success ? '‚úÖ SUCESSO' : '‚ùå FALHOU'}`);
    console.log(`üéØ Fluxo Geral: ${results.flowSuccess ? '‚úÖ SUCESSO' : '‚ùå FALHOU'}`);
    
    if (results.flowSuccess) {
        console.log('\nüéâ FLUXO DE PRODU√á√ÉO FUNCIONANDO!');
        console.log('‚úÖ O diagn√≥stico principal est√° sendo enviado corretamente');
        console.log('‚úÖ Mesmo se o update falhar, o fluxo continua');
        console.log('‚úÖ N√£o haver√° mais problema de "s√≥ funcionar na segunda vez"');
        console.log('‚úÖ Sistema robusto com fallbacks implementados');
        
        if (!results.updateFields?.success) {
            console.log('\nüí° OBSERVA√á√ÉO:');
            console.log('‚ö†Ô∏è Update fields ainda falha, mas isso n√£o impacta o diagn√≥stico');
            console.log('üìù O importante √© que o diagn√≥stico principal funcione (e est√° funcionando!)');
        }
        
    } else {
        console.log('\n‚ùå FLUXO AINDA COM PROBLEMAS');
        console.log('üîß O diagn√≥stico principal precisa funcionar sempre');
    }
    
    // Salvar relat√≥rio final
    const fs = require('fs');
    const finalReport = {
        dealId: DEAL_ID,
        timestamp: new Date().toISOString(),
        testType: 'production-flow-complete',
        results: results,
        conclusion: results.flowSuccess ? 
            'FLUXO DE PRODU√á√ÉO FUNCIONANDO - Diagn√≥stico principal OK' : 
            'FLUXO AINDA PRECISA CORRE√á√ïES',
        recommendations: results.flowSuccess ? [
            'Deploy das melhorias implementadas',
            'Monitorar logs em produ√ß√£o',
            'Update fields pode ser investigado separadamente'
        ] : [
            'Investigar problema no diagn√≥stico principal',
            'Verificar configura√ß√£o do workflow N8N'
        ]
    };
    
    fs.writeFileSync(`production-flow-complete-${DEAL_ID}.json`, JSON.stringify(finalReport, null, 2));
    console.log(`\nüìÑ Relat√≥rio final salvo em: production-flow-complete-${DEAL_ID}.json`);
    
    return finalReport;
}

if (require.main === module) {
    runProductionFlowTest().catch(console.error);
}

module.exports = { runProductionFlowTest, testProductionFlow };
