<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Dados da Chamada</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        pre { background: #fff; padding: 10px; border: 1px solid #ddd; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç Debug - Dados da Chamada Espec√≠fica</h1>
    <p>Investigando inconsist√™ncias na chamada: <code>5091c852-7fce-4cbd-ac11-790da156a214</code></p>
    
    <button onclick="debugCallData()">üîç Verificar Dados da Chamada</button>
    <button onclick="debugAudioUrl()">üéµ Analisar URL do √Åudio</button>
    <button onclick="debugTranscription()">üìù Verificar Transcri√ß√£o</button>
    
    <div id="results"></div>

    <script>
        // Configura√ß√£o do Supabase
        const supabaseUrl = 'https://pqmjfwmbitodwtpedlle.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxbWpmd21iaXRvZHd0cGVkbGxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjQ4NzQ0NzQsImV4cCI6MjA0MDQ1MDQ3NH0.0PlBhixdcx6c5VJv7fCXJOB_pVUKbbyVFjvYFQTtKHE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        const callId = '5091c852-7fce-4cbd-ac11-790da156a214';
        
        function addResult(title, content, type = 'result') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
            document.getElementById('results').appendChild(div);
        }
        
        async function debugCallData() {
            try {
                addResult('üîÑ Buscando dados da chamada...', 'Executando query...', 'result');
                
                const { data, error } = await supabase
                    .from('calls')
                    .select('*')
                    .eq('id', callId)
                    .single();
                
                if (error) {
                    addResult('‚ùå Erro ao buscar dados', JSON.stringify(error, null, 2), 'error');
                    return;
                }
                
                if (!data) {
                    addResult('‚ö†Ô∏è Chamada n√£o encontrada', 'Nenhum resultado retornado', 'error');
                    return;
                }
                
                // Analisar dados importantes
                const analysis = {
                    id: data.id,
                    duration: data.duration,
                    created_at: data.created_at,
                    status: data.status,
                    status_voip: data.status_voip,
                    recording_url: data.recording_url,
                    audio_url: data.audio_url,
                    transcription_length: data.transcription ? data.transcription.length : 0,
                    transcription_preview: data.transcription ? data.transcription.substring(0, 200) + '...' : 'Sem transcri√ß√£o',
                    person: data.person,
                    enterprise: data.enterprise,
                    sdr_name: data.sdr_name,
                    deal_id: data.deal_id
                };
                
                addResult('‚úÖ Dados da Chamada', JSON.stringify(analysis, null, 2), 'success');
                
                // Verificar inconsist√™ncias
                const issues = [];
                if (data.duration && data.duration > 900) { // > 15 min
                    issues.push(`Dura√ß√£o muito alta: ${data.duration} segundos (${Math.round(data.duration/60)} min)`);
                }
                if (data.recording_url && data.recording_url.includes('duration')) {
                    issues.push('URL do √°udio cont√©m informa√ß√£o de dura√ß√£o');
                }
                if (!data.transcription) {
                    issues.push('Sem transcri√ß√£o dispon√≠vel');
                }
                
                if (issues.length > 0) {
                    addResult('‚ö†Ô∏è Poss√≠veis Problemas Identificados', issues.join('\n'), 'error');
                } else {
                    addResult('‚úÖ Nenhum problema √≥bvio identificado', 'Dados parecem consistentes', 'success');
                }
                
            } catch (err) {
                addResult('‚ùå Erro inesperado', err.message, 'error');
            }
        }
        
        async function debugAudioUrl() {
            try {
                const { data } = await supabase
                    .from('calls')
                    .select('recording_url, audio_url, duration')
                    .eq('id', callId)
                    .single();
                
                if (!data) {
                    addResult('‚ùå Chamada n√£o encontrada', '', 'error');
                    return;
                }
                
                const audioAnalysis = {
                    recording_url: data.recording_url,
                    audio_url: data.audio_url,
                    duration_from_db: data.duration,
                    url_analysis: {
                        has_recording_url: !!data.recording_url,
                        has_audio_url: !!data.audio_url,
                        recording_url_length: data.recording_url ? data.recording_url.length : 0,
                        contains_duration_info: data.recording_url ? data.recording_url.includes('duration') : false
                    }
                };
                
                addResult('üéµ An√°lise do √Åudio', JSON.stringify(audioAnalysis, null, 2), 'success');
                
                // Tentar fazer uma requisi√ß√£o HEAD para o √°udio (se poss√≠vel)
                if (data.recording_url) {
                    try {
                        const response = await fetch(data.recording_url, { method: 'HEAD' });
                        const headers = {};
                        for (let [key, value] of response.headers.entries()) {
                            headers[key] = value;
                        }
                        addResult('üåê Headers do √Åudio', JSON.stringify(headers, null, 2), 'success');
                    } catch (fetchError) {
                        addResult('‚ö†Ô∏è N√£o foi poss√≠vel acessar o √°udio', fetchError.message, 'error');
                    }
                }
                
            } catch (err) {
                addResult('‚ùå Erro ao analisar √°udio', err.message, 'error');
            }
        }
        
        async function debugTranscription() {
            try {
                const { data } = await supabase
                    .from('calls')
                    .select('transcription, duration, sdr_name, person')
                    .eq('id', callId)
                    .single();
                
                if (!data) {
                    addResult('‚ùå Chamada n√£o encontrada', '', 'error');
                    return;
                }
                
                const transcriptionAnalysis = {
                    has_transcription: !!data.transcription,
                    transcription_length: data.transcription ? data.transcription.length : 0,
                    sdr_name: data.sdr_name,
                    person_name: data.person,
                    duration: data.duration,
                    transcription_preview: data.transcription ? data.transcription.substring(0, 500) : 'Sem transcri√ß√£o'
                };
                
                addResult('üìù An√°lise da Transcri√ß√£o', JSON.stringify(transcriptionAnalysis, null, 2), 'success');
                
                if (data.transcription) {
                    // An√°lise b√°sica do conte√∫do
                    const words = data.transcription.split(/\s+/).length;
                    const estimatedMinutes = words / 150; // ~150 palavras por minuto
                    const actualMinutes = data.duration / 60;
                    
                    const contentAnalysis = {
                        word_count: words,
                        estimated_duration_minutes: Math.round(estimatedMinutes * 10) / 10,
                        actual_duration_minutes: Math.round(actualMinutes * 10) / 10,
                        discrepancy: Math.abs(estimatedMinutes - actualMinutes) > 5 ? 'ALTA' : 'BAIXA'
                    };
                    
                    addResult('üìä An√°lise de Conte√∫do', JSON.stringify(contentAnalysis, null, 2), 
                        contentAnalysis.discrepancy === 'ALTA' ? 'error' : 'success');
                }
                
            } catch (err) {
                addResult('‚ùå Erro ao analisar transcri√ß√£o', err.message, 'error');
            }
        }
    </script>
</body>
</html>
